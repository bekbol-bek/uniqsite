{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{% static 'img/math_test.ico' %}">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <title>Создать Математический Тест</title>
    <style>
        {% load static %}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .math-test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .main-content {
            background: white;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .content {
            padding: 40px;
        }

        .help-sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .help-sidebar h2 {
    color: #6366f1;
    margin-bottom: 25px;
    font-size: 1.4em;
    text-align: center;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 15px;
}

.help-item {
    background: white;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 16px;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}

.help-item:hover {
    border-color: #6366f1;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
}

.help-item h4 {
    color: #374151;
    margin: 0 0 10px 0;
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.help-item p {
    color: #6b7280;
    margin: 8px 0;
    font-size: 0.9em;
    line-height: 1.5;
}

.help-item ul {
    color: #6b7280;
    margin: 8px 0;
    padding-left: 20px;
    font-size: 0.9em;
}

.help-item li {
    margin-bottom: 4px;
    line-height: 1.4;
}

.help-examples {
    background: linear-gradient(135deg, #f0f4ff 0%, #f8faff 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #e0e7ff;
}

.help-examples h4 {
    color: #4f46e5;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.example {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border-left: 4px solid #6366f1;
}

.example strong {
    color: #374151;
    display: block;
    margin-bottom: 6px;
}

.example p {
    color: #6b7280;
    margin: 0;
    font-size: 0.85em;
    line-height: 1.4;
}

.help-tip {
    background: linear-gradient(135deg, #f0fff4 0%, #f8fff8 100%);
    border-radius: 12px;
    padding: 18px;
    border: 1px solid #d1fae5;
}

.help-tip h4 {
    color: #059669;
    margin: 0 0 8px 0;
    font-size: 1em;
}

.help-tip p {
    color: #065f46;
    margin: 0;
    font-size: 0.9em;
    line-height: 1.5;
}

/* Адаптивность */
@media (max-width: 1024px) {
    .help-sidebar {
        position: static;
        margin-top: 30px;
    }
}

        .format-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .format-button {
            display: block;
            cursor: pointer;
        }

        .format-button input[type="radio"] {
            display: none;
        }

        .format-button-content {
            border: 2px solid #e5e7eb;
            background: white;
            padding: 20px 15px;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .format-button input[type="radio"]:checked + .format-button-content {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        .format-icon {
            font-size: 2em;
        }

        .format-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .format-text strong {
            font-weight: 600;
        }

        .format-text small {
            color: #6b7280;
            font-size: 0.8em;
        }

        .question-section, .answers-section {
            margin: 30px 0;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1em;
            margin: 10px 0;
            resize: vertical;
        }

        .keyboard-toggle {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .keyboard-toggle:hover {
            background: #4f46e5;
        }

        .math-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 50px;
            border: 2px dashed #dee2e6;
            font-family: 'Times New Roman', serif;
            font-size: 18px;
        }

        .answer-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            border: 2px solid #e5e7eb;
            margin: 15px 0;
        }

        .correct-answer {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            cursor: pointer;
        }

        .add-button, .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
         .submit-btn {
            background: #10b981;
         }

        .btn-primary {
            background: #6366f1;
        }

        .delete-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Модальное окно клавиатуры */
        .math-keyboard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .math-keyboard-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        /* Стили вашей математической клавиатуры */
        .keyboard-container {
            padding: 0;
        }

        .keyboard-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .formula-display {
            background: #f8f9fa;
            padding: 20px;
            min-height: 80px;
            border-bottom: 2px solid #e9ecef;
            font-size: 24px;
            text-align: center;
            font-family: 'Times New Roman', serif;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .keyboard-tabs {
            display: flex;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            overflow-x: auto;
        }

        .keyboard-tab {
            padding: 15px 20px;
            color: white;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .keyboard-tab.active {
            background: rgba(255,255,255,0.2);
        }

        .keyboard-panel {
            background: #ecf0f1;
            padding: 20px;
            min-height: 200px;
            display: none;
        }

        .keyboard-panel.active {
            display: block;
        }

        .keyboard-section {
            margin-bottom: 15px;
        }

        .keyboard-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .key {
            min-width: 70px;
            padding: 15px 10px;
            background: white;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: all 0.2s ease;
            font-family: 'Times New Roman', serif;
            flex: 1;
        }

        .key:hover {
            background: #3498db;
            color: white;
            border-color: #2980b9;
            transform: translateY(-2px);
        }

        .keyboard-controls {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            border-radius: 0 0 15px 15px;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-primary { background: #3498db; color: white; }

        /* Стили для плейсхолдеров */
        .placeholder {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
            display: inline-block;
        }

        .placeholder.filled {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        /* Математические стили */
        .sup {
            vertical-align: super;
            font-size: 0.7em;
        }

        .sub {
            vertical-align: sub;
            font-size: 0.7em;
        }

        .fraction {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    margin: 0 3px;
    vertical-align: middle;
}




        .numerator {
    display: block;
    padding: 0 5px;
    font-size: 0.9em;
    border-bottom: 3px solid black; /* ЖИРНАЯ линия */
}

.denominator {
    display: block;
    padding: 0 5px;
    font-size: 0.9em;
}

        .sqrt {
            position: relative;
            padding-left: 10px;
        }

        .sqrt::before {
            content: "√";
            position: absolute;
            left: 0;
            top: -2px;
            font-size: 1.2em;
        }

        .superscript {
    font-size: 0.7em;
    vertical-align: super;
    line-height: 1;
}

.subscript {
    font-size: 0.7em;
    vertical-align: sub;
    line-height: 1;
}







.integral-with-limits {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 5px;
}

.integral-upper {
    font-size: 0.7em;
    line-height: 1;
    margin-bottom: 1px;
}

.integral-lower {
    font-size: 0.7em;
    line-height: 1;
    margin-top: 1px;
}

.integral-symbol {
    font-size: 1.6em;
    line-height: 1;
}
/* Стиль для математического корня */
.sqrt-symbol {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    font-family: "Times New Roman", serif;
}

.sqrt-symbol svg {
    display: inline-block;
    vertical-align: middle;
}

.sqrt-content {
    border-top: 2px solid currentColor;
    padding: 0 12px;
    margin-left: -10px;
    font-style: italic;
    font-size: 1.1em;
}
        /* Стили для красивого корня с чертой */
.math-formula-display span[style*="inline-flex"] {
    display: inline-flex !important;
    align-items: center !important;
    position: relative !important;
}

.math-formula-display .superscript {
    font-size: 0.7em;
    vertical-align: super;
    line-height: 1;
    margin-right: 2px;
    position: relative;
    top: -5px;
}

        /* Стили для загрузки изображений */
.image-upload-section {
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #dee2e6;
}

.upload-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #495057;
    font-size: 14px;
}

.upload-label.small {
    font-size: 12px;
    margin-bottom: 5px;
}

.image-upload-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    font-size: 14px;
}

.image-upload-input.small {
    padding: 8px;
    font-size: 12px;
}

.image-preview {
    margin-top: 10px;
    display: none;
}

.image-preview img {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.image-preview.small img {
    max-width: 120px;
    max-height: 80px;
}

.answer-image-upload {
    margin-bottom: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px dashed #dee2e6;
}
/* Стили для загрузки изображений ответов */
.answer-image-upload {
    margin-bottom: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px dashed #dee2e6;
}

.upload-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #495057;
    font-size: 14px;
}

.upload-label.small {
    font-size: 12px;
    margin-bottom: 5px;
}

.image-upload-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    font-size: 14px;
}

.image-upload-input.small {
    padding: 8px;
    font-size: 12px;
}

.image-preview {
    margin-top: 10px;
    display: none;
}

.image-preview img {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.image-preview.small img {
    max-width: 120px;
    max-height: 80px;
}
        /* Стили для загрузки изображений ответов */
.answer-image-upload {
    margin-bottom: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px dashed #dee2e6;
}

.upload-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #495057;
    font-size: 14px;
}

.upload-label.small {
    font-size: 12px;
    margin-bottom: 5px;
}

.image-upload-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    font-size: 14px;
}

.image-upload-input.small {
    padding: 8px;
    font-size: 12px;
}

.image-preview {
    margin-top: 10px;
    display: none;
}

.image-preview img {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.image-preview.small img {
    max-width: 120px;
    max-height: 80px;
}

        .question-block {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.question-title {
    color: #2c3e50;
    margin: 0;
}

.remove-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.answers-container {
    margin: 20px 0;
}

.answer-block {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #e9ecef;
    position: relative;
}

.remove-answer-btn {
    position: absolute;
    top: 1px;
    right: 1px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

        /* Контейнер загрузки изображения */
.image-upload-section {
    margin: 20px 0;
}

/* Метка */
.upload-label {
    display: block;
    margin-bottom: 12px;
    font-weight: 600;
    color: #374151;
    font-size: 16px;
}

/* Горизонтальный контейнер для загрузки */
.image-upload-horizontal {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    background: #f9fafb;
    transition: all 0.3s ease;
    position: relative;
    min-height: 80px;
}

.image-upload-horizontal:hover {
    border-color: #6366f1;
    background: #f0f4ff;
}

/* Превью изображения */
.image-preview-horizontal {
    width: 120px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #e5e7eb;
    display: none;
}

/* Контейнер превью */
.image-preview-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* Когда есть изображение */
.image-upload-horizontal.has-image .upload-placeholder-horizontal {
    display: none;
}

.image-upload-horizontal.has-image .image-preview-horizontal {
    display: block;
}

/* Плейсхолдер загрузки */
.upload-placeholder-horizontal {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    cursor: pointer;
    padding: 10px;
}

.placeholder-icon-horizontal {
    width: 40px;
    height: 40px;
    background: #6366f1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
}

.placeholder-text-horizontal {
    display: flex;
    flex-direction: column;
}

.placeholder-title-horizontal {
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.placeholder-subtitle-horizontal {
    color: #6b7280;
    font-size: 12px;
}

/* Скрытый инпут */
.image-upload-input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    cursor: pointer;
}

/* Кнопка удаления */
.remove-image-btn-horizontal {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: #ef4444;
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    z-index: 10;
}

.image-preview-container:hover .remove-image-btn-horizontal {
    display: flex;
}

/* Информация о загруженном файле */
.file-info-horizontal {
    display: none;
    align-items: center;
    gap: 10px;
    margin-left: auto;
}

.image-upload-horizontal.has-image .file-info-horizontal {
    display: flex;
}

.file-name-horizontal {
    font-size: 14px;
    color: #374151;
    font-weight: 500;
}

.file-size-horizontal {
    font-size: 12px;
    color: #6b7280;
    background: #f3f4f6;
    padding: 2px 8px;
    border-radius: 12px;
}

        /* Горизонтальный контейнер для ответа */
.answer-content-horizontal {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
}

/* Текстовое поле ответа */
.answer-text-input-horizontal {
    flex: 1;
    min-width: 200px;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    transition: all 0.3s ease;
}

.answer-text-input-horizontal:focus {
    border-color: #6366f1;
    outline: none;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.answer-text-input-horizontal::placeholder {
    color: #9ca3af;
}

/* Контейнер загрузки изображения ответа */
.answer-image-upload-horizontal {
    position: relative;
    min-width: 120px;
    height: 60px;
}

/* Стили для загрузки изображения */
.image-upload-horizontal-small {
    width: 120px;
    height: 60px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    background: #f9fafb;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.image-upload-horizontal-small:hover {
    border-color: #6366f1;
    background: #f0f4ff;
}

/* Превью изображения ответа */
.image-preview-horizontal-small {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
    display: none;
}

/* Иконка загрузки */
.upload-icon-horizontal {
    width: 24px;
    height: 24px;
    color: #6b7280;
    transition: color 0.3s ease;
}

.image-upload-horizontal-small:hover .upload-icon-horizontal {
    color: #6366f1;
}

/* Когда есть изображение */
.answer-image-upload-horizontal.has-image .image-preview-horizontal-small {
    display: block;
}

.answer-image-upload-horizontal.has-image .upload-icon-horizontal {
    display: none;
}

/* Кнопка удаления изображения */
.remove-image-btn-horizontal-small {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 20px;
    height: 20px;
    background: #ef4444;
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    z-index: 10;
    transition: all 0.3s ease;
}

.answer-image-upload-horizontal:hover .remove-image-btn-horizontal-small {
    display: flex;
}

.remove-image-btn-horizontal-small:hover {
    background: #dc2626;
    transform: scale(1.1);
}

/* Скрытый инпут */
.image-upload-input-horizontal {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    cursor: pointer;
}

/* Правильный ответ */
.correct-option-horizontal {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 10px;
}

.radio-input-horizontal {
    display: none;
}

.radio-label-horizontal {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 16px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.radio-label-horizontal:hover {
    border-color: #10b981;
    color: #059669;
}

.radio-input-horizontal:checked + .radio-label-horizontal {
    background: #10b981;
    border-color: #10b981;
    color: white;
}

.radio-icon-horizontal {
    font-size: 16px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .answer-content-horizontal {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }

    .answer-text-input-horizontal {
        min-width: auto;
    }

    .answer-image-upload-horizontal {
        align-self: flex-start;
    }

    .correct-option-horizontal {
        margin-left: 0;
        justify-content: center;
    }
}
        .correct-option {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    padding: 10px 16px;
    background: white;
    border-radius: 20px;
    transition: all 0.3s ease;
    border: 2px solid var(--border);
    max-width: 300px;
}

.correct-option:hover {
    border-color: var(--success);
    background: rgba(40, 167, 69, 0.05);
}

/* Скрываем стандартный radio */
.correct-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

/* Кастомный радио кружок */
.correct-option input[type="radio"] + span::before {
    content: '';
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-radius: 50%;
    margin-right: 8px;
    transition: all 0.3s ease;
    position: relative;
    top: 2px;
}

/* ЗЕЛЕНЫЙ стиль для выбранного радио */
.correct-option input[type="radio"]:checked + span::before {
    border-color: #28a745;
    background: #28a745;
    box-shadow: inset 0 0 0 3px white;
}

/* ЗЕЛЕНЫЙ текст при выборе */
.correct-option input[type="radio"]:checked + span {
    color: #28a745;
    font-weight: 600;
}

/* ЗЕЛЕНАЯ рамка и фон при выборе */
.correct-option:has(input[type="radio"]:checked) {
    border-color: #28a745;
    background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
}

/* Если не работают CSS переменные, добавьте: */
:root {
    --border: #ddd;
    --success: #28a745;
}

        .editable {
    min-width: 20px;
    min-height: 1em;
    border: 1px dashed #ccc;
    padding: 2px 4px;
    margin: 1px;
}

.editable:focus {
    border-color: #007bff;
    outline: none;
    background: #f8f9fa;
}
        /* Стиль для активного редактируемого поля */
[contenteditable="true"]:focus {
    outline: 2px solid #4CAF50 !important;
    outline-offset: 2px !important;
    background: #f0fff0 !important;
}
        .big-brackets {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    font-family: 'Times New Roman', serif;
}

.bracket-left, .bracket-right {
    font-size: 1.5em;
    line-height: 1;
    display: flex;
    align-items: center;
}

.bracket-content {
    padding: 0 2px;
    display: inline-block;
}

/* Особые стили для разных типов скобок */
.big-brackets.parentheses .bracket-left,
.big-brackets.parentheses .bracket-right {
    font-size: 1.8em;
}

.big-brackets.square .bracket-left,
.big-brackets.square .bracket-right {
    font-size: 1.6em;
    font-weight: bold;
}

.big-brackets.braces .bracket-left,
.big-brackets.braces .bracket-right {
    font-size: 1.7em;
    font-weight: bold;
}

/* Автоподстройка размера скобок под содержимое */
.big-brackets:has(.fraction) .bracket-left,
.big-brackets:has(.fraction) .bracket-right {
    font-size: 2em;
}

.big-brackets:has(.big-brackets) .bracket-left,
.big-brackets:has(.big-brackets) .bracket-right {
    font-size: 2.2em;
}

        .subscript {
    font-size: 0.7em;
    vertical-align: sub;
    line-height: 1;
    display: inline-block;
}

/* Стили для кастомного ввода */
.custom-input-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-input-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.custom-input-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 400px;
    z-index: 2001;
    position: relative;
}

.custom-input-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.custom-input-header h3 {
    margin: 0;
    font-size: 1.2em;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-input-body {
    padding: 25px;
}

.custom-input-field {
    width: 100%;
    padding: 15px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
    transition: border-color 0.3s ease;
}

.custom-input-field:focus {
    border-color: #6366f1;
    outline: none;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.custom-input-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.custom-input-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.cancel-btn {
    background: #f3f4f6;
    color: #6b7280;
}

.cancel-btn:hover {
    background: #e5e7eb;
}

.confirm-btn {
    background: #6366f1;
    color: white;
}

.confirm-btn:hover {
    background: #4f46e5;
}
        @keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.math-keyboard-notification {
    font-family: Arial, sans-serif;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

        /* Стили для кастомного модального окна подтверждения */
.custom-confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-confirm-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
}

.custom-confirm-container {
    position: relative;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 400px;
    animation: modalSlideIn 0.3s ease;
}

.custom-confirm-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.custom-confirm-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.custom-confirm-header .close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.custom-confirm-header .close-btn:hover {
    background: #f8f9fa;
    color: #333;
}

.custom-confirm-body {
    padding: 20px;
}

.custom-confirm-body p {
    margin: 0 0 20px 0;
    color: #555;
    line-height: 1.5;
}

.custom-confirm-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.custom-confirm-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 500;
    transition: all 0.2s ease;
}

.custom-confirm-btn.cancel-btn {
    background: #6c757d;
    color: white;
}

.custom-confirm-btn.cancel-btn:hover {
    background: #5a6268;
}

.custom-confirm-btn.confirm-btn {
    background: #dc3545;
    color: white;
}

.custom-confirm-btn.confirm-btn:hover {
    background: #c82333;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}


        /* Стили для нового layout */
.keyboard-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    max-height: 80vh;
}

.video-sidebar {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    overflow-y: auto;
}

.video-section h3 {
    color: #6366f1;
    margin-bottom: 15px;
    font-size: 1.1em;
}

.video-container {
    margin-bottom: 20px;
}

.video-container video {
    width: 100%;
    border-radius: 8px;
    background: #000;
}

.video-title {
    margin-top: 8px;
    font-size: 0.9em;
    color: #374151;
    font-weight: 500;
}

.quick-tips {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.quick-tips h4 {
    color: #059669;
    margin-bottom: 10px;
    font-size: 1em;
}

.quick-tips ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.quick-tips li {
    padding: 5px 0;
    color: #6b7280;
    font-size: 0.9em;
    position: relative;
    padding-left: 15px;
}

.quick-tips li:before {
    content: "•";
    color: #6366f1;
    position: absolute;
    left: 0;
}

/* Адаптивность */
@media (max-width: 1200px) {
    .keyboard-layout {
        grid-template-columns: 1fr;
    }

    .video-sidebar {
        display: none;
    }
}
        /* Мобильная адаптация для страницы математического теста */
@media (max-width: 768px) {
    body {
        padding: 15px 10px !important;
        font-size: 16px;
    }

    .math-test-container {
        grid-template-columns: 1fr !important;
        gap: 20px;
        max-width: 100%;
    }

    /* Основной контент */
    .main-content {
        border-radius: 20px;
        margin: 0 auto;
    }

    /* Шапка */
    .header {
        padding: 25px 20px !important;
    }

    .header h1 {
        font-size: 1.8em !important;
        text-align: center;
    }

    /* Контент */
    .content {
        padding: 25px 20px !important;
    }

    /* Боковая панель помощи */
    .help-sidebar {
        padding: 25px 20px !important;
        border-radius: 20px;
        position: static;
        margin-top: 20px;
    }

    .help-sidebar h2 {
        font-size: 1.3em;
        text-align: center;
    }

    .help-item {
        padding: 20px 15px !important;
        margin-bottom: 20px;
    }

    .help-item h4 {
        font-size: 1.1em;
    }

    .help-item p, .help-item ul {
        font-size: 1em;
        line-height: 1.5;
    }

    .help-examples {
        padding: 20px 15px;
        margin: 20px 0;
    }

    .example {
        padding: 15px;
        margin-bottom: 15px;
    }

    .help-tip {
        padding: 20px 15px;
    }

    /* Выбор формата */
    .format-buttons {
        grid-template-columns: 1fr !important;
        gap: 12px;
        margin-top: 20px;
    }

    .format-button-content {
        padding: 25px 20px !important;
        min-height: 100px;
        gap: 12px;
    }

    .format-icon {
        font-size: 2.2em !important;
    }

    .format-text strong {
        font-size: 1.1em;
    }

    .format-text small {
        font-size: 0.9em;
    }

    /* Секции вопросов и ответов */
    .question-section, .answers-section {
        margin: 25px 0;
    }

    .question-block {
        padding: 20px 15px !important;
        margin-bottom: 20px;
        border-radius: 15px;
    }

    .question-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
        margin-bottom: 20px;
    }

    .question-title {
        font-size: 1.2em;
        text-align: center;
    }

    .remove-btn {
        padding: 14px 20px !important;
        font-size: 16px;
        min-height: 50px;
        justify-content: center;
        width: 100%;
    }

    /* Поля ввода */
    textarea {
        padding: 18px 15px !important;
        font-size: 18px !important;
        border-radius: 15px;
        min-height: 120px;
        margin: 12px 0;
    }

    .math-preview {
        padding: 20px 15px;
        margin: 15px 0;
        font-size: 20px;
        min-height: 70px;
    }

    /* Кнопка клавиатуры */
    .keyboard-toggle {
        padding: 16px 20px !important;
        font-size: 17px;
        border-radius: 12px;
        min-height: 55px;
        width: 100%;
        justify-content: center;
        margin: 15px 0;
    }

    /* Элементы ответов */
    .answer-item {
        padding: 20px 15px !important;
        margin: 20px 0;
        border-radius: 15px;
    }

    .answer-block {
        padding: 20px 15px !important;
        margin-bottom: 15px;
        border-radius: 12px;
    }

    .remove-answer-btn {
        width: 30px;
        height: 30px;
        font-size: 16px;
        top: 8px;
        right: 8px;
    }

    /* Горизонтальные ответы */
    .answer-content-horizontal {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }

    .answer-text-input-horizontal {
        min-width: auto;
        padding: 16px 15px !important;
        font-size: 16px;
        min-height: 55px;
    }

    .answer-image-upload-horizontal {
        align-self: center;
        min-width: 140px;
        height: 80px;
    }

    .image-upload-horizontal-small {
        width: 140px;
        height: 80px;
    }

    .correct-option-horizontal {
        margin-left: 0;
        justify-content: center;
    }

    .radio-label-horizontal {
        padding: 14px 20px !important;
        font-size: 16px;
        min-height: 50px;
        justify-content: center;
    }

    /* Правильный ответ */
    .correct-option {
        max-width: 100% !important;
        width: 100%;
        padding: 16px 20px !important;
        font-size: 16px;
        min-height: 55px;
        justify-content: center;
        margin: 10px 0;
    }

    .correct-option input[type="radio"] + span::before {
        width: 20px;
        height: 20px;
    }

    /* Загрузка изображений */
    .image-upload-section {
        margin: 20px 0;
    }

    .upload-label {
        font-size: 17px;
        margin-bottom: 15px;
        text-align: center;
    }

    .image-upload-horizontal {
        min-height: 100px;
        padding: 20px 15px;
        flex-direction: column;
        gap: 15px;
    }

    .upload-placeholder-horizontal {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }

    .placeholder-icon-horizontal {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }

    .placeholder-title-horizontal {
        font-size: 16px;
    }

    .placeholder-subtitle-horizontal {
        font-size: 14px;
    }

    .image-preview-horizontal {
        width: 100%;
        max-width: 200px;
        height: 120px;
    }

    /* Кнопки действий */
    .action-buttons {
        flex-direction: column;
        gap: 15px;
        margin-top: 25px;
    }

    .btn {
        padding: 18px 25px !important;
        font-size: 17px !important;
        font-weight: 600;
        border-radius: 15px;
        min-height: 60px;
        width: 100% !important;
        justify-content: center;
        text-align: center;
        margin: 5px 0 !important;
    }

    .submit-btn {
        order: 1;
        font-size: 18px !important;
        min-height: 65px;
    }

    .add-button {
        order: 2;
    }

    .btn-primary {
        order: 3;
    }

    .delete-button {
        padding: 12px 20px !important;
        font-size: 16px;
        min-height: 50px;
        width: 100%;
        justify-content: center;
    }

    /* Модальное окно клавиатуры */
    .modal-content {
        width: 98% !important;
        margin: 10px;
        max-height: 85vh;
    }

    .keyboard-header {
        padding: 20px 15px;
    }

    .formula-display {
        padding: 20px 15px;
        font-size: 20px;
        min-height: 70px;
    }

    .keyboard-tabs {
        flex-wrap: wrap;
    }

    .keyboard-tab {
        padding: 12px 15px;
        font-size: 13px;
        flex: 1;
        min-width: 80px;
        text-align: center;
    }

    .keyboard-panel {
        padding: 15px 10px;
    }

    .keyboard-row {
        gap: 8px;
        margin-bottom: 8px;
    }

    .key {
        min-width: 60px;
        padding: 12px 8px;
        font-size: 14px;
        flex: 1;
    }

    .keyboard-controls {
        padding: 15px 10px;
        flex-direction: column;
        gap: 10px;
    }

    .control-btn {
        padding: 14px 20px;
        font-size: 16px;
        width: 100%;
        min-height: 50px;
    }

    /* Кастомные модальные окна */
    .custom-input-container,
    .custom-confirm-container {
        width: 95% !important;
        max-width: 350px;
    }

    .custom-input-body,
    .custom-confirm-body {
        padding: 20px 15px;
    }

    .custom-input-field {
        padding: 16px 15px;
        font-size: 18px;
        min-height: 55px;
    }

    .custom-input-buttons,
    .custom-confirm-buttons {
        flex-direction: column;
        gap: 10px;
    }

    .custom-input-btn,
    .custom-confirm-btn {
        padding: 14px 20px;
        font-size: 16px;
        min-height: 50px;
        width: 100%;
    }

    /* Улучшение фокуса */
    textarea:focus,
    .answer-text-input-horizontal:focus,
    .custom-input-field:focus {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2) !important;
        transform: translateY(-2px);
    }
}

/* Для очень маленьких экранов */
@media (max-width: 480px) {
    body {
        padding: 10px 8px !important;
    }

    .header {
        padding: 20px 15px !important;
    }

    .header h1 {
        font-size: 1.6em !important;
    }

    .content {
        padding: 20px 15px !important;
    }

    .help-sidebar {
        padding: 20px 15px !important;
    }

    .format-button-content {
        padding: 20px 15px !important;
        min-height: 90px;
    }

    textarea {
        padding: 16px 12px !important;
        font-size: 16px !important;
    }

    .btn {
        padding: 16px 20px !important;
        font-size: 16px !important;
        min-height: 55px;
    }

    .key {
        min-width: 50px;
        padding: 10px 6px;
        font-size: 13px;
    }

    .keyboard-tab {
        padding: 10px 8px;
        font-size: 12px;
    }
}

/* Горизонтальная ориентация */
@media (max-width: 768px) and (orientation: landscape) {
    body {
        padding: 10px !important;
    }

    .math-test-container {
        gap: 15px;
    }

    .content,
    .help-sidebar {
        padding: 20px !important;
    }

    .format-buttons {
        grid-template-columns: repeat(2, 1fr) !important;
    }

    textarea {
        min-height: 80px;
        padding: 14px 12px !important;
    }

    .btn {
        padding: 14px 18px !important;
        min-height: 50px;
    }

    .modal-content {
        max-height: 80vh;
    }

    .keyboard-layout {
        grid-template-columns: 1fr;
        max-height: 70vh;
    }

    .video-sidebar {
        display: none;
    }
}

/* Улучшение касаний для мобильных */
@media (max-width: 768px) {
    .btn,
    .add-button,
    .delete-button,
    .keyboard-toggle,
    .format-button,
    .key,
    .keyboard-tab,
    .correct-option,
    .radio-label-horizontal,
    .remove-btn,
    .remove-answer-btn,
    .image-upload-horizontal,
    .image-upload-horizontal-small,
    textarea,
    input[type="text"],
    input[type="radio"] {
        -webkit-tap-highlight-color: transparent;
        cursor: pointer;
    }

    .btn:active,
    .add-button:active,
    .delete-button:active,
    .keyboard-toggle:active,
    .format-button:active,
    .key:active,
    .correct-option:active {
        transform: scale(0.98) !important;
    }

    /* Увеличиваем область клика */
    .correct-option,
    .radio-label-horizontal {
        min-height: 55px;
        display: flex;
        align-items: center;
    }

    .format-button-content {
        min-height: 100px;
    }
}

/* Оптимизация анимаций для мобильных */
@media (max-width: 768px) {
    .question-block:hover,
    .answer-item:hover,
    .help-item:hover,
    .format-button:hover,
    .btn:hover {
        transform: none;
    }

    .question-block:active,
    .answer-item:active,
    .help-item:active,
    .format-button:active {
        transform: scale(0.98);
    }

    .key:hover {
        transform: none;
    }

    .key:active {
        transform: scale(0.95);
    }
}

/* Убираем масштабирование при фокусе на iOS */
@media (max-width: 768px) {
    textarea,
    .answer-text-input-horizontal,
    .custom-input-field {
        font-size: 16px !important;
    }
}

/* Улучшение для длинных текстов */
@media (max-width: 768px) {
    .header h1,
    .help-sidebar h2,
    .question-title,
    .format-text strong,
    .format-text small {
        word-wrap: break-word;
        overflow-wrap: break-word;
        text-align: center;
    }

    .math-preview {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
}

        .vertical-stack {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 3px;
}

.stack-top, .stack-bottom {
    padding: 0 5px;
    min-height: 1.2em;
    min-width: 20px;
    text-align: center;
    border: 1px dashed #ccc;
}

.stack-top {
    border-bottom: none;
}

.vertical-no-line {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 3px;
}

.vtop, .vbottom {
    padding: 0 5px;
    min-height: 1.2em;
    min-width: 20px;
    text-align: center;
    border: 1px dashed #ccc;
}

.vertical-bold-line {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 3px;
}

.bold-top, .bold-bottom {
    padding: 0 5px;
    min-height: 1.2em;
    min-width: 20px;
    text-align: center;
    border: 1px dashed #ccc;
}

.bold-line {
    width: 100%;
    height: 2px;
    background: #000;
    margin: 2px 0;
}
        .vertical-stack-container {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 5px;
    border: 2px dashed #e0e0e0;
    border-radius: 4px;
    padding: 2px;
}

.stack-top, .stack-bottom {
    padding: 8px 12px;
    min-height: 1.5em;
    min-width: 30px;
    text-align: center;
    border: 1px dashed #ccc;
    margin: 2px;
    background: white;
}

.stack-top {
    border-bottom: 2px solid #000;
}

.stack-top:focus, .stack-bottom:focus {
    outline: 2px solid #4CAF50;
    background: #f0fff0;
}
        .vertical-stack-container {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 5px;
    border: 2px dashed #e0e0e0;
    border-radius: 4px;
    padding: 2px;
    background: #f9f9f9;
}

.stack-top, .stack-bottom {
    padding: 8px 12px;
    min-height: 1.5em;
    min-width: 30px;
    text-align: center;
    border: 1px dashed #ccc;
    margin: 2px;
    background: white;
    cursor: text;
    font-family: 'Times New Roman', serif;
    font-size: 16px;
}

.stack-top {
    border-bottom: 2px solid #000;
}

.stack-top:focus, .stack-bottom:focus {
    outline: 2px solid #4CAF50 !important;
    background: #f0fff0 !important;
}

        /* Стили для редактируемых полей в дробях и стеках */
.fraction {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 3px;
}

.numerator, .denominator {
    min-height: 1.5em;
    min-width: 30px;
    padding: 4px 8px;
    text-align: center;
    border: 1px dashed #ccc;
    background: white;
    font-family: 'Times New Roman', serif;
    font-size: 16px;
    line-height: 1.2;
}

.numerator {
    border-bottom: 2px solid #000;
    margin-bottom: 1px;
}

.denominator {
    margin-top: 1px;
}

/* Улучшенные стили для вертикальных стеков */
.vertical-stack-container {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 5px;
    border: 2px dashed #e0e0e0;
    border-radius: 4px;
    padding: 2px;
    background: #f9f9f9;
}

.stack-top, .stack-bottom {
    padding: 8px 12px;
    min-height: 1.5em;
    min-width: 30px;
    text-align: center;
    border: 1px dashed #ccc;
    margin: 2px;
    background: white;
    cursor: text;
    font-family: 'Times New Roman', serif;
    font-size: 16px;
    line-height: 1.2;
}

.stack-top {
    border-bottom: 2px solid #000;
}

/* Стили для активных редактируемых полей */
[contenteditable="true"] {
    outline: none;
    transition: all 0.2s ease;
}

[contenteditable="true"]:focus {
    outline: 2px solid #4CAF50 !important;
    background: #f0fff0 !important;
    border-color: #4CAF50 !important;
}

/* Плейсхолдеры для пустых полей */
[contenteditable="true"]:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
}

[contenteditable="true"]:focus:empty:before {
    color: #ccc;
}

/* Улучшенная видимость математических элементов */
.math-formula-display {
    line-height: 1.8;
    font-size: 18px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    min-height: 80px;
    border: 2px dashed #dee2e6;
}

/* Стили для лучшего отображения корней */
.sqrt-symbol {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
}

.sqrt-content {
    border-top: 2px solid currentColor;
    padding: 0 12px;
    margin-left: -8px;
    font-style: italic;
}

/* Улучшенные стили для верхних индексов */
.superscript {
    font-size: 0.7em;
    vertical-align: super;
    line-height: 1;
    position: relative;
    top: -0.4em;
}

/* Улучшенные стили для нижних индексов */
.subscript {
    font-size: 0.7em;
    vertical-align: sub;
    line-height: 1;
    position: relative;
    bottom: -0.2em;
}

/* Улучшенная видимость черты в дробях */
.fraction .numerator {
    border-bottom: 2px solid #000 !important;
    padding-bottom: 2px;
}

/* Стили для лучшего UX при редактировании */
.editing-highlight {
    animation: pulse-highlight 1.5s ease-in-out;
}

@keyframes pulse-highlight {
    0% { background-color: #f0fff0; }
    50% { background-color: #e0f7e0; }
    100% { background-color: #f0fff0; }
}

/* Улучшенная видимость для мобильных устройств */
@media (max-width: 768px) {
    .numerator, .denominator {
        min-height: 2em;
        padding: 8px 10px;
        font-size: 18px;
    }

    .stack-top, .stack-bottom {
        min-height: 2em;
        padding: 10px 12px;
        font-size: 18px;
    }

    .math-formula-display {
        font-size: 20px;
        padding: 20px;
    }
}
        /* Улучшенные стили для редактируемых полей в дробях */
.fraction {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 2px;
}

.numerator, .denominator {
    min-height: 1.4em;
    min-width: 25px;
    padding: 2px 6px;
    text-align: center;
    border: 1px solid #ddd;
    background: white;
    font-family: 'Times New Roman', serif;
    font-size: 16px;
    line-height: 1.2;
    outline: none;
}

.numerator {
    border-bottom: 1px solid #000 !important;
    border-radius: 3px 3px 0 0;
}

.denominator {
    border-top: none;
    border-radius: 0 0 3px 3px;
}

/* Улучшенные стили для вертикальных стеков */
.vertical-stack-container {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 3px;
}

.stack-top, .stack-bottom {
    padding: 4px 8px;
    min-height: 1.4em;
    min-width: 25px;
    text-align: center;
    border: 1px solid #ddd;
    background: white;
    font-family: 'Times New Roman', serif;
    font-size: 16px;
    line-height: 1.2;
    outline: none;
}

.stack-top {
    border-bottom: 1px solid #000 !important;
    border-radius: 3px 3px 0 0;
}

.stack-bottom {
    border-top: none;
    border-radius: 0 0 3px 3px;
}

/* Стили для активных полей */
[contenteditable="true"]:focus {
    background: #f0f9ff !important;
    border-color: #4CAF50 !important;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
}

/* Убираем стандартное поведение плейсхолдеров */
[contenteditable="true"]:empty:before {
    content: none !important;
}

/* Стили для текста внутри редактируемых полей */
.numerator, .denominator,
.stack-top, .stack-bottom {
    color: #333;
    font-weight: normal;
}

/* Улучшенное отображение формулы */
.math-formula-display {
    line-height: 1.6;
    font-size: 18px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    min-height: 80px;
    border: 2px dashed #dee2e6;
}

/* Стили для лучшего отображения математических символов */
.sqrt-symbol {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
}

.sqrt-content {
    border-top: 1px solid currentColor;
    padding: 0 8px;
    margin-left: -6px;
}

/* Убираем лишние отступы и границы */
.big-brackets {
    display: inline-flex;
    align-items: center;
}

.bracket-left, .bracket-right {
    font-size: 1.2em;
}






/* Стили для дробей с редактируемыми полями */
.fraction .numerator.editable-field,
.fraction .denominator.editable-field {
    border: 1px dashed #ccc;
    min-width: 25px;
    text-align: center;
    display: block;
}

.fraction .numerator.editable-field {
    border-bottom: 2px solid #000 !important;
}

/* Стили для верхних/нижних индексов */
.superscript.editable-field,
.subscript.editable-field {
    font-size: 0.7em;
    min-width: 10px;
    border: 1px dashed #ccc;
}

        /* Стили для редактируемых полей */
.editable-field {
    display: inline-block;
    min-width: 20px;
    min-height: 1.2em;
    border: 1px dashed #ccc;
    padding: 2px 4px;
    margin: 0 1px;
    background: white;
    cursor: text;
    outline: none;
    vertical-align: middle;
    line-height: 1.2;
}

.editable-field:focus {
    border: 2px solid #4CAF50 !important;
    background: #f0fff0 !important;
    outline: none;
}

/* Стили для дробей */
.fraction {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 3px;
}

.fraction .numerator,
.fraction .denominator {
    padding: 2px 6px;
    min-width: 25px;
    text-align: center;
    border: 1px dashed #ccc;
    background: white;
}

.fraction .numerator {
    border-bottom: 2px solid #000;
    margin-bottom: 1px;
}

.fraction .denominator {
    margin-top: 1px;
}

/* Стили для корней */
.sqrt-symbol {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
}

.sqrt-content {
    border-top: 2px solid currentColor;
    padding: 0 8px;
    margin-left: -2px;
}

/* Стили для вертикального стека (дроби) */
.vertical-stack-container {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    margin: 0 5px;
    position: relative;
}

.stack-top, .stack-bottom {
    padding: 2px 8px;
    min-width: 30px;
    min-height: 1.2em;
    text-align: center;
    border: 1px dashed #ccc;
    background: white;
    font-family: 'Times New Roman', serif;
    line-height: 1.2;
}

.stack-top {
    border-bottom: 2px solid #000 !important;
    margin-bottom: 1px;
}

.stack-bottom {
    margin-top: 1px;
}

/* Убедитесь, что редактируемые поля работают правильно */
.vertical-stack-container .editable-field:focus {
    border: 2px solid #4CAF50 !important;
    background: #f0fff0 !important;
    outline: none;
}

.stack-top, .stack-bottom {
    padding: 2px 6px;
    min-width: 25px;
    text-align: center;
    border: 1px dashed #ccc;
    background: white;
}

.stack-top {
    border-bottom: 2px solid #000;
    margin-bottom: 1px;
}

.stack-bottom {
    margin-top: 1px;
}

/* Стили для верхних/нижних индексов */
sup, sub {
    font-size: 0.7em;
    line-height: 0; /* Убираем стандартный line-height */
    vertical-align: baseline; /* Сбрасываем выравнивание */
    position: relative; /* Для позиционирования */
}

sup {
    vertical-align: super; /* Делаем выше */
    top: -0.5em; /* Поднимаем еще выше */
}

sub {
    vertical-align: sub;
    bottom: -0.25em; /* Опускаем ниже */
}

sup.editable-field,
sub.editable-field {
    min-width: 10px;
    border: 1px dashed #ccc;
    padding: 1px 3px;
    display: inline-block;
}

/* Особые стили для степеней в дробях и корнях */
.fraction .numerator sup,
.fraction .denominator sup,
.sqrt-content sup {
    top: -0.6em; /* Еще выше в специальных контекстах */
    font-size: 0.6em; /* Чуть меньше размер */
}

/* Улучшенные стили для степеней в шаблоне power */
[data-template="power"] sup.editable-field {
    top: -0.7em;
    font-size: 0.65em;
    margin-left: 1px;
}

/* Стили для маленькой степени отдельно */
[data-template="small_power"] sup.editable-field {
    top: -0.8em;
    font-size: 0.6em;
    min-width: 8px;
    padding: 1px 2px;
}

/* Стили для больших скобок */
.big-brackets {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
}

.bracket-left, .bracket-right {
    font-size: 1.5em;
    line-height: 1;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .editable-field {
        min-width: 25px;
        min-height: 1.5em;
        padding: 4px 6px;
        font-size: 18px;
    }

    .fraction .numerator,
    .fraction .denominator {
        min-width: 30px;
        padding: 4px 8px;
        font-size: 16px;
    }
}

        /* Основной редактируемый дисплей */
.math-formula-editable {
    min-height: 80px;
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
    font-size: 18px;
    line-height: 1.6;
    font-family: 'Times New Roman', serif;
    outline: none;
    white-space: normal;
    word-wrap: break-word;
}

.math-formula-editable:focus {
    border-color: #4CAF50;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
}

/* Стили для математических шаблонов */
.math-template {
    display: inline-block;
    vertical-align: middle;
    margin: 0 2px;
    position: relative;
}

/* Дроби */
.fraction {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
}

.numerator, .denominator {
    padding: 2px 8px;
    min-width: 20px;
    text-align: center;
    background: white;
    border: 1px dashed #ccc;
}

.fraction-line {
    width: 100%;
    height: 2px;
    background: #000;
    margin: 2px 0;
}

/* Корни */
.sqrt-symbol {
    display: inline-flex;
    align-items: center;
    font-family: 'Times New Roman', serif;
}

.sqrt-content {
    border-top: 2px solid currentColor;
    padding: 0 8px;
    margin-left: -2px;
    font-style: italic;
}

/* Степени */
.power-template {
    display: inline-flex;
    align-items: baseline;
}

.base, .exponent {
    padding: 1px 4px;
    border: 1px dashed #ccc;
    background: white;
}

.exponent {
    font-size: 0.7em;
    margin-left: 1px;
}

/* Функции */
.function {
    font-family: 'Times New Roman', serif;
}

.function-content {
    padding: 1px 4px;
    border: 1px dashed #ccc;
    background: white;
    margin: 0 2px;
}

/* Скобки */
.big-brackets {
    display: inline-flex;
    align-items: center;
}

.bracket-left, .bracket-right {
    font-size: 1.5em;
    line-height: 1;
}

.bracket-content {
    padding: 1px 6px;
    border: 1px dashed #ccc;
    background: white;
    margin: 0 2px;
}

/* Вертикальные стеки */
.vertical-stack {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    border: 1px dashed #e0e0e0;
    border-radius: 4px;
    padding: 2px;
}

.stack-top, .stack-bottom {
    padding: 4px 8px;
    min-width: 25px;
    text-align: center;
    border: 1px dashed #ccc;
    background: white;
}

.stack-line {
    width: 100%;
    height: 1px;
    background: #000;
    margin: 2px 0;
}

/* Подсветка при фокусе */
.math-template:focus-within {
    outline: 2px solid #4CAF50;
    border-radius: 3px;
}

.numerator:focus, .denominator:focus,
.base:focus, .exponent:focus,
.function-content:focus, .bracket-content:focus,
.stack-top:focus, .stack-bottom:focus {
    outline: 2px solid #2196F3;
    background: #f0f9ff;
}

/* Адаптивность */
@media (max-width: 768px) {
    .math-formula-editable {
        font-size: 16px;
        padding: 15px;
        min-height: 60px;
    }

    .numerator, .denominator,
    .stack-top, .stack-bottom {
        padding: 3px 6px;
        min-width: 20px;
    }
}
        /* Стиль для видимого курсора */
.math-cursor {
    display: inline-block;
    width: 2px;
    background: #4CAF50;
    animation: blink 1s infinite;
    margin: 0 1px;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/* Улучшенные стили для фокуса */
.math-formula-editable:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
}

.editable-field:focus,
.numerator:focus,
.denominator:focus,
.stack-top:focus,
.stack-bottom:focus {
    outline: 2px solid #2196F3 !important;
    background: #f0f9ff !important;
}
/* Улучшенные стили для корней */
.sqrt-symbol {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    font-family: 'Times New Roman', serif;
    position: relative;
}

.sqrt-content {
    border-top: 2px solid currentColor;
    padding: 0 15px;
    margin-left: -1px;
    font-style: italic;
    display: inline-flex;
    align-items: center;
    gap: 2px;
}

/* Специфичные стили для разных типов корней */
.sqrt-symbol:not(:has(sup)) .sqrt-content {
    margin-left: -3px;
}

.sqrt-symbol:has(sup) {
    align-items: baseline;
}

.sqrt-symbol:has(sup) .sqrt-content {
    margin-left: -2px;
    margin-top: 0px;
}

/* Стили для верхнего индекса в корне n-ной степени */
.sqrt-symbol > sup {
    position: relative;
    top: -8px;
    left: 2px;
    font-size: 0.7em;
    margin-right: -4px;
}

/* Убедитесь, что черта отображается во всех случаях */
.math-formula-display .sqrt-content {
    border-top: 2px solid currentColor !important;
}

/* Стили для лучшего отображения в превью */
.math-preview .sqrt-symbol {
    display: inline-flex !important;
    align-items: center !important;
}

.math-preview .sqrt-content {
    border-top: 2px solid currentColor !important;
    display: inline-flex !important;
    align-items: center !important;
}


        .math-formula-editable {
    caret-color: #4CAF50; /* Зеленый курсор для лучшей видимости */
}

.math-formula-editable:focus {
    outline: 2px solid #4CAF50;
}

/* Убедитесь, что редактируемые поля не ломают поток */
.editable-field {
    display: inline-block;
    min-width: 20px;
    min-height: 1.2em;
}

        /* ФИКС: Отключаем авто-фокус для полей внутри шаблонов */
.math-template [contenteditable="true"] {
    outline: none !important;
    background: transparent !important;
}

/* Включаем стили фокуса ТОЛЬКО когда пользователь сам кликает */
.math-template [contenteditable="true"]:focus {
    outline: 2px solid #4CAF50 !important;
    background: #f0fff0 !important;
}

/* ОСНОВНОЙ дисплей - обычные стили фокуса */
.math-formula-editable[contenteditable="true"]:focus {
    outline: 2px solid #4CAF50 !important;
    background: #f8f9fa !important;
}

/* Дополнительная защита - убираем любые автоматические выделения */
.math-template {
    user-select: none;
}

.math-template .editable-field {
    user-select: text;
}

        /* ПОЛНОСТЬЮ отключаем любые авто-фокус эффекты для шаблонов */
.math-template [contenteditable="true"] {
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
}

/* Включаем selection только при явном фокусе */
.math-template [contenteditable="true"]:focus {
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
}

/* Запрещаем автоматический фокус через CSS */
.math-template {
    pointer-events: none;
}

.math-template .editable-field {
    pointer-events: auto;
}

/* Основной дисплей всегда доступен для фокуса */
.math-formula-editable {
    pointer-events: auto !important;
    user-select: text !important;
}

        /* ПОЛНОСТЬЮ блокируем авто-фокус на полях шаблонов */
.math-template [contenteditable="true"] {
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
}

/* Включаем selection только при явном фокусе */
.math-template [contenteditable="true"]:focus {
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
}

/* Основной дисплей всегда доступен */
.math-formula-editable {
    user-select: text !important;
    -webkit-user-select: text !important;
}
    </style>
    <style>
        .photo-requirement-section {
    margin: 20px 0;
    padding: 20px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    border-left: 4px solid #007bff;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    margin: 0;
}

.checkbox-label input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 4px;
    margin-right: 12px;
    margin-top: 2px;
    position: relative;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.checkbox-label input[type="checkbox"]:checked + .checkmark {
    background-color: #007bff;
    border-color: #007bff;
}

.checkbox-label input[type="checkbox"]:checked + .checkmark:after {
    content: '✓';
    position: absolute;
    color: white;
    font-size: 14px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.checkbox-text {
    display: flex;
    flex-direction: column;
}

.checkbox-text strong {
    color: #333;
    font-size: 14px;
    margin-bottom: 4px;
}

.checkbox-text small {
    color: #666;
    font-size: 12px;
    line-height: 1.4;
}
    </style>
    <style>
        /* Стили для полей с плейсхолдерами */
.math-placeholder-field {
    position: relative;
    min-width: 20px;
    min-height: 1em;
    border: 1px dashed #ccc;
    padding: 0 4px;
    margin: 0 2px;
}

.math-placeholder-field.show-placeholder::before {
    content: var(--placeholder-text);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #999;
    font-style: italic;
    pointer-events: none;
}

.math-placeholder-field:focus {
    border-color: #4F46E5;
    outline: none;
}

/* Скрываем плейсхолдер при фокусе и когда есть текст */
.math-placeholder-field:not(.show-placeholder)::before {
    display: none;
}
    </style>
</head>
<body>
    <div class="math-test-container">
        <div class="main-content">
            <div class="header">
                <h1><i class="fi fi-sr-folder-math"></i> Создать Математический Тест</h1>
            </div>

            <div class="content">
                <form method="post" id="mathTestForm"  enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Тип вопроса -->


                    <!-- Вопрос -->


                    <!-- Ответы -->
                    <!-- Контейнер для всех вопросов -->
                    <div id="questions-container">
                        <!-- Вопросы будут добавляться здесь автоматически -->
                    </div>

                    <div class="buttons-container">
                        <button type="button" class="btn add-btn" onclick="addQuestion()">
                            <i class="fi fi-sr-seal-question"></i> Добавить вопрос
                        </button>

                        <button type="submit" class="btn submit-btn">
                            <i class="fi fi-sr-check-circle"></i> Завершить создание теста
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Боковая панель -->
        <div class="help-sidebar">
            <h2>🎯 Как использовать клавиатуру</h2>

            <div class="help-item">
                <h4>🔤 1. Начните с основных символов</h4>
                <p>Используйте вкладку <strong>"Основные"</strong> для цифр, букв и простых операций: + - × ÷ = ( )</p>
            </div>

            <div class="help-item">
                <h4>📐 2. Добавьте математические функции</h4>
                <p>Перейдите на вкладки:</p>
                <ul>
                    <li><strong>Алгебра</strong> - дроби, корни, степени</li>
                    <li><strong>Геометрия</strong> - тригонометрия, греческие буквы</li>
                    <li><strong>Матанализ</strong> - интегралы, производные, пределы</li>
                </ul>
            </div>

            <div class="help-item">
                <h4>□ 3. Заполняйте плейсхолдеры</h4>
                <p>Нажимайте на квадратики <strong>□</strong> чтобы:</p>
                <ul>
                    <li>Ввести числа или переменные</li>
                    <li>Добавить другие математические выражения</li>
                    <li>Создать сложные формулы</li>
                </ul>
            </div>

            <div class="help-item">
                <h4>🔄 4. Редактируйте в любое время</h4>
                <p>Можно в любой момент:</p>
                <ul>
                    <li>Нажать на заполненный плейсхолдер для изменения</li>
                    <li>Использовать ⌫ для удаления</li>
                    <li>Нажать "Очистить" чтобы начать заново</li>
                </ul>
            </div>

            <div class="help-item">
                <h4>💾 5. Сохраните и вставьте</h4>
                <p>Когда формула готова:</p>
                <ul>
                    <li>Нажмите <strong>"Сохранить"</strong> чтобы не потерять</li>
                    <li>Нажмите <strong>"Вставить формулу"</strong> чтобы добавить в вопрос</li>
                </ul>
            </div>

            <div class="help-examples">
                <h4>📝 Примеры создания формул:</h4>
                <div class="example">
                    <strong>Дробь с степенью:</strong>
                    <p>1. Нажмите "a/b" → 2. Заполните числитель → 3. Нажмите " ⁿ " в числителе → 4. Заполните степень</p>
                </div>
                <div class="example">
                    <strong>Корень с показателем:</strong>
                    <p>1. Нажмите "√xⁿ" → 2. Заполните основание → 3. Заполните показатель степени</p>
                </div>
                <div class="example">
                    <strong>Скобки с выражением:</strong>
                    <p>1. Нажмите "( )" → 2. Заполните содержимое скобок любой формулой</p>
                </div>
            </div>

            <div class="help-tip">
                <h4>💡 Совет</h4>
                <p>Можно вкладывать формулы друг в друга! Например: дробь внутри корня, или степень в числителе дроби.</p>
            </div>
        </div>
    </div>

    <!-- Модальное окно математической клавиатуры -->
    <div class="math-keyboard-modal" id="mathKeyboardModal">
        <div class="modal-content">
          <div class="keyboard-layout">
            <div class="keyboard-container">
                <div class="keyboard-header">
                    <h2><i class="fi fi-sr-folder-math"></i> Математическая Клавиатура</h2>
                    <p>Создайте формулу и нажмите "Вставить". Нажимайте на □ чтобы заполнить.</p>
                </div>

                <div class="formula-display" id="formulaDisplay">
                    Ваша формула появится здесь...
                </div>

                <div class="keyboard-tabs">
                    <button class="keyboard-tab active" data-tab="basic">Основные</button>
                    <button class="keyboard-tab" data-tab="algebra">Алгебра</button>
                    <button class="keyboard-tab" data-tab="geometry">Геометрия</button>
                    <button class="keyboard-tab" data-tab="calculus">Матанализ</button>
                </div>

                <!-- Основные -->
                <div class="keyboard-panel active" id="basicPanel">
                    <div class="keyboard-section">
                        <div class="keyboard-row">
                            <div class="key" data-symbol="x">x</div>
                            <div class="key" data-symbol="y">y</div>
                            <div class="key" data-symbol="z">z</div>
                            <div class="key" data-symbol="a">a</div>
                            <div class="key" data-symbol="b">b</div>
                            <div class="key" data-symbol="c">c</div>

                        </div>
                    </div>

                    <div class="keyboard-section">
                        <div class="keyboard-row">
                            <div class="key" data-symbol="1">1</div>
                            <div class="key" data-symbol="2">2</div>
                            <div class="key" data-symbol="3">3</div>
                            <div class="key" data-symbol="+" style="background: #ffccd8b3;">+</div>
                            <div class="key" data-template="power">xⁿ</div>
                            <div class="key" data-symbol="(">(</div>
                            <div class="key" data-symbol=")">)</div>
                        </div>
                        <div class="keyboard-row">
                            <div class="key" data-symbol="4">4</div>
                            <div class="key" data-symbol="5">5</div>
                            <div class="key" data-symbol="6">6</div>
                            <div class="key" data-symbol="-" style="background: #ffccd8b3;">-</div>
                            <div class="key" data-symbol="π">π</div>
                            <div class="key" data-symbol="[">[</div>
                            <div class="key" data-symbol="]">]</div>
                        </div>
                        <div class="keyboard-row">
                            <div class="key" data-symbol="7">7</div>
                            <div class="key" data-symbol="8">8</div>
                            <div class="key" data-symbol="9">9</div>
                            <div class="key" data-symbol="*" style="background: #ffccd8b3;">×</div>
                            <div class="key" data-symbol="=">=</div>
                            <div class="key" data-symbol="{">{</div>
                            <div class="key" data-symbol="}">}</div>
                        </div>
                        <div class="keyboard-row">
                            <div class="key" data-symbol="0">0</div>
                            <div class="key" data-symbol=".">.</div>
                            <div class="key" data-symbol=",">,</div>
                            <div class="key" data-symbol=":" style="background: #ffccd8b3;">÷</div>
                            <div class="key" data-symbol="e">e</div>
                            <div class="key" data-symbol="∞">∞</div>
                            <div class="key" data-action="backspace">⌫</div>
                        </div>
                    </div>
                </div>

                <!-- Алгебра -->
                <div class="keyboard-panel" id="algebraPanel">
                    <div class="keyboard-section">
                        <div class="keyboard-row">
                            <div class="key" data-template="sqrt">√x</div>
                            <div class="key" data-template="sqrt_power">√xⁿ</div> <!-- НОВАЯ КНОПКА -->
                            <div class="key" data-template="nroot">ⁿ√x</div>
                            <div class="key" data-template="square">x²</div>
                            <div class="key" data-template="cube">x³</div>
                            <div class="key" data-template="power">xⁿ</div>
                            <div class="key" data-template="small_power">□ⁿ</div> <!-- НОВАЯ КНОПКА - ТОЛЬКО МАЛЕНЬКАЯ СТЕПЕНЬ -->
                        </div>

                        <div class="keyboard-row">
                            <div class="key" data-template="frac">a/b</div>

<!--                            <div class="key" data-template="binom">C(n,k)</div>-->
<!--                            <div class="key" data-template="factorial">n!</div>-->
                            <div class="key" data-template="abs">|x|</div>
<!--                            <div class="key" data-template="sum">∑</div>-->
                            <div class="key" data-symbol="f">f</div>
                            <div class="key" data-symbol="F">F</div>

                        </div>

                        <div class="keyboard-row">
                            <div class="key" data-template="big_parentheses_right">(</div>
                            <div class="key" data-template="big_parentheses_left">)</div><!-- Большие круглые -->
                            <div class="key" data-template="big_brackets_right">[</div> <!-- Большие квадратные -->            <!-- Большие фигурные -->
                            <div class="key" data-template="big_brackets_left">]</div>
                            <div class="key" data-template="big_braces_right">{</div> <!-- Большие фигурные -->
                            <div class="key" data-template="big_braces_left">}</div>
                            <div class="key" data-template="log">log</div>
                        </div>

                    </div>
                </div>

                <!-- Геометрия -->
                <div class="keyboard-panel" id="geometryPanel">
                    <div class="keyboard-section">
                        <div class="keyboard-row">
                            <div class="key" data-template="sin">sin(x)</div>
                            <div class="key" data-template="cos">cos(x)</div>
                            <div class="key" data-template="tan">tg(x)</div>
                            <div class="key" data-template="cot">ctg(x)</div>
                            <div class="key" data-template="subscript">□ₙ</div>
                            <div class="key" data-template="just">(x)</div>
                        </div>
                        <div class="keyboard-row">
                            <div class="key" data-symbol="α">α</div>
                            <div class="key" data-symbol="β">β</div>
                            <div class="key" data-symbol="γ">γ</div>
                            <div class="key" data-symbol="θ">θ</div>
                            <div class="key" data-symbol="φ">φ</div>
                            <div class="key" data-symbol="ω">ω</div>
                        </div>
                    </div>
                </div>

                <!-- Матанализ -->
                <div class="keyboard-panel" id="calculusPanel">
                    <div class="keyboard-section">
                        <div class="keyboard-row">
<!--                            <div class="key" data-template="derivative">dy/dx</div>-->
<!--                            <div class="key" data-template="partial">∂f/∂x</div>-->
                            <div class="key" data-template="integral">∫f(x)dx</div>
                            <div class="key" data-template="integral_limits">∫⁰₀</div>
                            <div class="key" data-template="def_integral">∫ₐᵇf(x)dx</div>
                            <div class="key" data-symbol="∫">∫</div>
                        </div>
                        <div class="keyboard-row">
                            <div class="key" data-template="limit">lim</div>
<!--                            <div class="key" data-template="series">∑aₙ</div>-->
<!--                            <div class="key" data-template="nabla">∇</div>-->
<!--                            <div class="key" data-template="laplacian">Δ</div>-->
                        </div>
                    </div>
                </div>

                <div class="keyboard-controls">
                    <button class="control-btn btn-danger" id="clearBtn"><i class="fi fi-ss-eraser"></i> Очистить</button>
                    <button class="control-btn btn-primary" id="saveBtn"><i class="fi fi-sr-bookmark"></i> Сохранить</button>
                    <button class="control-btn btn-success" onclick="insertFormula()"><i class="fi fi-sr-check-circle"></i> Вставить формулу</button>
                    <button class="control-btn" onclick="closeMathKeyboard()"><i class="fi fi-sr-circle-x"></i> Закрыть</button>
                </div>
            </div>
            <!-- Правая часть - видео -->
            <div class="video-sidebar">
                <div class="video-section">
                    <h3><i class="fi fi-sr-play"></i> Видео-обучение</h3>
                    <div class="video-container">
                        <video controls>
                            <source src="{% static 'video/clideo_editor_9b61fcb68bee422f970548f823f49dde.mp4' %}" type="video/mp4">
                            Ваш браузер не поддерживает видео.
                        </video>
                        <div class="video-title">Создание формулы </div>
                    </div>

                    <div class="video-container">
                        <video controls>
                            <source src="{% static 'video/clideo_editor_9b61fcb68bee422f970548f823f49dde.mp4' %}" type="video/mp4">
                            Ваш браузер не поддерживает видео.
                        </video>
                        <div class="video-title">Создание формулы </div>
                    </div>
                </div>
                <div class="quick-tips">
                    <h4><i class="fi fi-sr-bulb"></i> Быстрые подсказки</h4>
                    <ul>
                        <li>Нажимайте на □ для редактирования</li>
                        <li>Используйте вкладки для разных функций</li>
                        <li>Сохраняйте сложные формулы</li>
                    </ul>
                </div>
            </div>
          </div>
        </div>
    </div>

    <script>

   // Глобальные переменные
let currentInputField = '';
let mathKeyboard = null;
let questionCount = 0;
let answerCounts = []; // Будет хранить количество ответов для каждого вопроса

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    addQuestion(); // Добавляем первый вопрос автоматически
});

// Функции для управления модальным окном
function openMathKeyboard(field) {
    currentInputField = field;
    document.getElementById('mathKeyboardModal').classList.add('active');

    // Инициализируем клавиатуру если еще не инициализирована
    if (!mathKeyboard) {
        mathKeyboard = new MathKeyboard();
    }
}

function closeMathKeyboard() {
    document.getElementById('mathKeyboardModal').classList.remove('active');
}

// Обновленная функция вставки формулы
function insertFormula() {
    if (mathKeyboard && currentInputField) {
        // ИСПРАВЛЕНИЕ: используем статическую версию вместо редактируемой
        const staticFormula = mathKeyboard.getStaticFormula();

        if (currentInputField.startsWith('question_')) {
            const questionIndex = currentInputField.split('_')[1];
            document.getElementById(`mathExpression_${questionIndex}`).value = staticFormula;
            document.getElementById(`questionMathPreview_${questionIndex}`).innerHTML = staticFormula;
        } else if (currentInputField.startsWith('answer_')) {
            const parts = currentInputField.split('_');
            const questionIndex = parts[1];
            const answerIndex = parts[2];

            document.getElementById(`answerFormula_${questionIndex}_${answerIndex}`).value = staticFormula;
            document.getElementById(`answerPreview_${questionIndex}_${answerIndex}`).innerHTML = staticFormula;
        }
    }
    closeMathKeyboard();
}

function addQuestion() {
    const questionsContainer = document.getElementById('questions-container');
    const newQuestionIndex = questionCount;

    const newQuestion = `
        <div class="question-block" data-question-index="${newQuestionIndex}">
            <div class="question-header">
                <h3 class="question-title">
                    <i class="fi fi-sr-seal-question"></i> Вопрос ${newQuestionIndex + 1}
                </h3>
                <button type="button" class="remove-btn" onclick="removeQuestion(${newQuestionIndex})"
                        ${newQuestionIndex === 0 ? 'style="display: none;"' : ''}>
                    <i class="fi fi-br-x"></i>
                </button>
            </div>

            <!-- Тип вопроса -->
            <div class="format-section">
                <h4><i class="fi fi-br-bullseye-arrow"></i> Тип математического вопроса:</h4>
                <div class="format-buttons">
                    <label class="format-button">
                        <input type="radio" name="question_format_${newQuestionIndex}" value="math_formula" checked>
                        <div class="format-button-content">
                            <span class="format-icon">∫</span>
                            <span class="format-text">
                                <strong>Формулы</strong>
                                <small>Выбор формулы</small>
                            </span>
                        </div>
                    </label>

                    <label class="format-button">
                        <input type="radio" name="question_format_${newQuestionIndex}" value="math_equation">
                        <div class="format-button-content">
                            <span class="format-icon">=</span>
                            <span class="format-text">
                                <strong>Уравнения</strong>
                                <small>Решение уравнений</small>
                            </span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Текст вопроса -->
            <div class="input-group">
                <textarea name="question_text_${newQuestionIndex}" placeholder="Введите текст вопроса..." rows="3" required></textarea>
            </div>

           <!-- Изображение вопроса в горизонтальном стиле -->
            <div class="image-upload-section">
                <label class="upload-label">
                    <i class="fi fi-sr-camera"></i> Добавить изображение к вопросу (графики, диаграммы)
                </label>

                <div class="image-upload-horizontal" id="imageUpload_${newQuestionIndex}">
                    <!-- Контейнер превью -->
                    <div class="image-preview-container">
                        <img class="image-preview-horizontal"
                             id="questionImagePreview_${newQuestionIndex}"
                             alt="Предпросмотр">
                        <button type="button" class="remove-image-btn-horizontal"
                                onclick="removeQuestionImage(${newQuestionIndex})">
                            ×
                        </button>
                    </div>

                    <!-- Плейсхолдер -->
                    <div class="upload-placeholder-horizontal">
                        <div class="placeholder-icon-horizontal">
                            <i class="fi fi-sr-camera"></i>
                        </div>
                        <div class="placeholder-text-horizontal">
                            <span class="placeholder-title-horizontal">Нажмите чтобы загрузить изображение</span>
                            <span class="placeholder-subtitle-horizontal">PNG, JPG, WEBP до 5MB</span>
                        </div>
                    </div>

                    <!-- Информация о файле -->
                    <div class="file-info-horizontal">
                        <span class="file-name-horizontal" id="fileName_${newQuestionIndex}"></span>
                        <span class="file-size-horizontal" id="fileSize_${newQuestionIndex}"></span>
                    </div>

                    <!-- Скрытый инпут -->
                    <input type="file" name="question_image_${newQuestionIndex}"
                           accept="image/*" class="image-upload-input"
                           onchange="handleQuestionImageUpload(this, ${newQuestionIndex})">
                </div>
            </div>

            <!-- Математическая формула вопроса -->
            <div class="math-formula-section">
                <button type="button" class="keyboard-toggle" onclick="openMathKeyboard('question_${newQuestionIndex}')">
                    <i class="fi fi-sr-folder-math"></i> Добавить математическую формулу к вопросу
                </button>
                <div id="questionMathPreview_${newQuestionIndex}" class="math-preview">
                    Математические формулы появятся здесь...
                </div>
                <input type="hidden" name="math_expression_${newQuestionIndex}" id="mathExpression_${newQuestionIndex}" value="">
            </div>

             <!-- Требование фото решения -->
            <div class="photo-requirement-section">
                <label class="checkbox-label">
                    <input type="checkbox"
                           id="requireSolutionPhoto_${newQuestionIndex}"
                           onchange="toggleSolutionRequirement(${newQuestionIndex})">
                    <span class="checkmark"></span>
                    <div class="checkbox-text">
                        <strong>Требовать фото решения от ученика</strong>
                        <small>Ученик должен будет сфотографировать и загрузить своё решение</small>
                    </div>
                </label>
            </div>

            <!-- Скрытое поле для передачи значения -->
            <input type="hidden" name="require_solution_photo_${newQuestionIndex}"
                   id="requireSolutionPhotoInput${newQuestionIndex}" value="false">

            <!-- Ответы -->
            <h4 class="answers-title"><i class="fi fi-br-answer-alt"></i> Ответы</h4>
            <div id="answers-${newQuestionIndex}" class="answers-container">
                <!-- Ответы будут добавляться здесь -->
            </div>

            <button type="button" class="btn add-answer-btn" onclick="addAnswer(${newQuestionIndex})">
                <i class="fi fi-br-plus"></i> Добавить ответ
            </button>
        </div>
    `;

    questionsContainer.insertAdjacentHTML('beforeend', newQuestion);
    answerCounts[newQuestionIndex] = 0;

    // Добавляем 2 начальных ответа
    addAnswer(newQuestionIndex);
    addAnswer(newQuestionIndex);

    questionCount++;
    setupImagePreviews();


}
// Добавьте эту функцию в ваш JavaScript
function toggleSolutionRequirement(questionIndex) {
    const checkbox = document.getElementById(`requireSolutionPhoto_${questionIndex}`);
    const hiddenInput = document.getElementById(`requireSolutionPhotoInput${questionIndex}`);

    if (checkbox && hiddenInput) {
        hiddenInput.value = checkbox.checked ? 'true' : 'false';
        console.log(`Question ${questionIndex}: require_solution_photo = ${hiddenInput.value}`);
    }
}

function addAnswer(questionIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerCount = answerCounts[questionIndex];
    const newAnswerIndex = answerCount;

    const newAnswer = `
        <div class="answer-block" data-answer-index="${newAnswerIndex}">
            <button type="button" class="remove-answer-btn" onclick="removeAnswer(${questionIndex}, ${newAnswerIndex})"
                    ${answerCount < 2 ? 'style="display: none;"' : ''}>×</button>

            <div class="answer-content">
                <!-- Горизонтальный блок ответа -->
<div class="answer-content-horizontal">

    <!-- Текстовое поле -->
    <input type="text"
           name="answer_text_${questionIndex}_${newAnswerIndex}"
           placeholder="Текст ответа..."
           class="answer-text-input-horizontal">

    <!-- Загрузка изображения -->
    <div class="answer-image-upload-horizontal"
         id="answerImageUpload_${questionIndex}_${newAnswerIndex}">

        <!-- Превью -->
        <img class="image-preview-horizontal-small"
             id="answerImagePreview_${questionIndex}_${newAnswerIndex}"
             alt="Предпросмотр">

        <!-- Иконка загрузки -->
        <div class="image-upload-horizontal-small">
            <span class="upload-icon-horizontal"><i class="fi fi-sr-camera"></i></span>
        </div>

        <!-- Кнопка удаления -->
        <button type="button"
                class="remove-image-btn-horizontal-small"
                onclick="removeAnswerImage(${questionIndex}, ${newAnswerIndex})">
            ×
        </button>

        <!-- Скрытый инпут -->
        <input type="file"
               name="answer_image_${questionIndex}_${newAnswerIndex}"
               accept="image/*"
               class="image-upload-input-horizontal"
               onchange="handleAnswerImageUpload(this, ${questionIndex}, ${newAnswerIndex})">
    </div>
</div>

                <!-- Формула ответа -->
                <div class="answer-formula-section">
                    <button type="button" class="keyboard-toggle small"
                            onclick="openMathKeyboard('answer_${questionIndex}_${newAnswerIndex}')">
                        <i class="fi fi-sr-folder-math"></i> Добавить формулу ответа
                    </button>
                    <div id="answerPreview_${questionIndex}_${newAnswerIndex}" class="math-preview small">
                        Формула ответа...
                    </div>
                    <input type="hidden" name="answer_formula_${questionIndex}_${newAnswerIndex}"
                           id="answerFormula_${questionIndex}_${newAnswerIndex}" value="">
                </div>

                <!-- Правильный ответ -->
                <label class="correct-option">
                    <input type="radio" name="correct_answer_${questionIndex}" value="${newAnswerIndex}"
                           ${newAnswerIndex === 0 ? 'required' : ''}>
                    <span class="correct-badge"> Правильный ответ</span>
                </label>
            </div>
        </div>
    `;

    answersContainer.insertAdjacentHTML('beforeend', newAnswer);
    answerCounts[questionIndex]++;
    setupImagePreviews();
}

function handleAnswerImageUpload(input, questionIndex, answerIndex) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        const preview = document.getElementById(`answerImagePreview_${questionIndex}_${answerIndex}`);
        const uploadContainer = document.getElementById(`answerImageUpload_${questionIndex}_${answerIndex}`);

        reader.onload = function(e) {
            preview.src = e.target.result;
            uploadContainer.classList.add('has-image');
        }
        reader.readAsDataURL(file);
    }
}

function removeAnswerImage(questionIndex, answerIndex) {
    const input = document.querySelector(`input[name="answer_image_${questionIndex}_${answerIndex}"]`);
    const preview = document.getElementById(`answerImagePreview_${questionIndex}_${answerIndex}`);
    const uploadContainer = document.getElementById(`answerImageUpload_${questionIndex}_${answerIndex}`);

    input.value = '';
    preview.src = '';
    uploadContainer.classList.remove('has-image');
}
function removeQuestion(questionIndex) {
    if (questionCount > 1) {
        const questionBlock = document.querySelector(`[data-question-index="${questionIndex}"]`);
        if (questionBlock) {
            questionBlock.remove();
            questionCount--;
            renumberQuestions();
        }
    }
}

function removeAnswer(questionIndex, answerIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerBlocks = answersContainer.querySelectorAll('.answer-block');

    if (answerBlocks.length > 2) {
        const answerBlock = document.querySelector(`[data-question-index="${questionIndex}"] .answer-block[data-answer-index="${answerIndex}"]`);
        if (answerBlock) {
            answerBlock.remove();
            answerCounts[questionIndex]--;
            renumberAnswers(questionIndex);
        }
    } else {
        alert('Должно быть минимум 2 ответа!');
    }
}

function renumberQuestions() {
    const questions = document.querySelectorAll('.question-block');
    questionCount = questions.length;

    questions.forEach((questionBlock, index) => {
        const newQuestionIndex = index;
        const oldQuestionIndex = parseInt(questionBlock.getAttribute('data-question-index'));

        questionBlock.setAttribute('data-question-index', newQuestionIndex);

        // Обновляем заголовок
        const title = questionBlock.querySelector('.question-title');
        title.innerHTML = `<i class="fi fi-sr-seal-question"></i> Вопрос ${newQuestionIndex + 1}`;

        // Обновляем имена полей в вопросе
        questionBlock.querySelectorAll('[name*="_' + oldQuestionIndex + '"]').forEach(field => {
            const newName = field.name.replace(`_${oldQuestionIndex}`, `_${newQuestionIndex}`);
            field.name = newName;
        });

        questionBlock.querySelectorAll('[id*="_' + oldQuestionIndex + '"]').forEach(element => {
            const newId = element.id.replace(`_${oldQuestionIndex}`, `_${newQuestionIndex}`);
            element.id = newId;
        });

        // Обновляем обработчики
        questionBlock.querySelector('.keyboard-toggle').setAttribute('onclick', `openMathKeyboard('question_${newQuestionIndex}')`);
        questionBlock.querySelector('.add-answer-btn').setAttribute('onclick', `addAnswer(${newQuestionIndex})`);
        questionBlock.querySelector('.remove-btn').setAttribute('onclick', `removeQuestion(${newQuestionIndex})`);

        // Обновляем ответы
        renumberAnswers(newQuestionIndex);
    });

    // Обновляем массив счетчиков ответов
    const newAnswerCounts = [];
    questions.forEach((_, index) => {
        const answersContainer = document.getElementById(`answers-${index}`);
        newAnswerCounts[index] = answersContainer.querySelectorAll('.answer-block').length;
    });
    answerCounts = newAnswerCounts;
}

function renumberAnswers(questionIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerBlocks = answersContainer.querySelectorAll('.answer-block');

    answerBlocks.forEach((block, newAnswerIndex) => {
        const oldAnswerIndex = parseInt(block.getAttribute('data-answer-index'));
        block.setAttribute('data-answer-index', newAnswerIndex);

        // Обновляем имена полей
        block.querySelectorAll('[name*="_' + oldAnswerIndex + '"]').forEach(field => {
            const newName = field.name.replace(`_${oldAnswerIndex}`, `_${newAnswerIndex}`);
            field.name = newName;
        });

        block.querySelectorAll('[id*="_' + oldAnswerIndex + '"]').forEach(element => {
            const newId = element.id.replace(`_${oldAnswerIndex}`, `_${newAnswerIndex}`);
            element.id = newId;
        });

        // Обновляем radio value
        const radioInput = block.querySelector('input[type="radio"]');
        radioInput.value = newAnswerIndex;

        // Обновляем обработчики
        const removeBtn = block.querySelector('.remove-answer-btn');
        removeBtn.setAttribute('onclick', `removeAnswer(${questionIndex}, ${newAnswerIndex})`);

        const formulaBtn = block.querySelector('.keyboard-toggle');
        formulaBtn.setAttribute('onclick', `openMathKeyboard('answer_${questionIndex}_${newAnswerIndex}')`);
    });

    answerCounts[questionIndex] = answerBlocks.length;

    // Показываем/скрываем кнопки удаления ответов
    answerBlocks.forEach((block, index) => {
        const removeBtn = block.querySelector('.remove-answer-btn');
        removeBtn.style.display = answerBlocks.length > 2 ? 'block' : 'none';
    });
}

function setupImagePreviews() {
    document.querySelectorAll('.image-upload-input').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                const preview = this.parentElement.querySelector('.image-preview');

                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Предпросмотр">`;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
    });
}

// Валидация и отправка формы
document.getElementById('mathTestForm').addEventListener('submit', function(e) {
    console.log("=== ПРОВЕРКА ФОРМЫ ПЕРЕД ОТПРАВКОЙ ===");

    let isValid = true;
    const questions = document.querySelectorAll('.question-block');

    // Проверяем каждый вопрос
    questions.forEach((question, qIndex) => {
        const questionIndex = question.getAttribute('data-question-index');
        const questionText = question.querySelector(`textarea[name="question_text_${questionIndex}"]`);
        const correctAnswer = question.querySelector(`input[name="correct_answer_${questionIndex}"]:checked`);

        console.log(`Вопрос ${questionIndex}:`);
        console.log(`  Текст: "${questionText.value}"`);
        console.log(`  Правильный ответ:`, correctAnswer ? correctAnswer.value : 'не выбран');

        // Проверка текста вопроса
        if (!questionText.value.trim()) {
            isValid = false;
            questionText.style.borderColor = '#dc3545';
            console.log(`  ❌ Ошибка: нет текста вопроса`);
        } else {
            questionText.style.borderColor = '';
        }

        // Проверка правильного ответа
        if (!correctAnswer) {
            isValid = false;
            console.log(`  ❌ Ошибка: не выбран правильный ответ`);
        }

        // Проверка ответов
        const answerBlocks = question.querySelectorAll('.answer-block');
        let hasValidAnswers = false;

        answerBlocks.forEach((answerBlock, aIndex) => {
            const answerText = answerBlock.querySelector(`input[name="answer_text_${questionIndex}_${aIndex}"]`).value.trim();
            const answerFormula = answerBlock.querySelector(`input[name="answer_formula_${questionIndex}_${aIndex}"]`).value;
            const answerImage = answerBlock.querySelector(`input[name="answer_image_${questionIndex}_${aIndex}"]`).files[0];

            console.log(`  Ответ ${aIndex}: текст="${answerText}", формула="${answerFormula}", фото=${answerImage ? 'есть' : 'нет'}`);

            if (answerText || answerFormula || answerImage) {
                hasValidAnswers = true;
            }
        });

        if (!hasValidAnswers) {
            isValid = false;
            console.log(`  ❌ Ошибка: нет ни одного заполненного ответа`);
        }
    });

    if (!isValid) {
        e.preventDefault();
        alert('❌ Пожалуйста, заполните все обязательные поля:\n- Текст вопроса\n- Хотя бы один ответ\n- Отметьте правильный ответ');
        return;
    }

    // Если все хорошо, показываем данные формы
    console.log("=== ВСЕ ДАННЫЕ ФОРМЫ ===");
    const formData = new FormData(this);
    for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
            console.log(`${key}: FILE - ${value.name} (${value.size} bytes)`);
        } else {
            console.log(`${key}: ${value}`);
        }
    }

    console.log("✅ Форма валидна, отправляем...");
});
class MathKeyboard {
    constructor() {
        this.currentFormula = '';
        this.lastActiveElement = null;
        this.isComposing = false;

       // Шаблоны с исправленными плейсхолдерами
        this.templates = {
            sqrt: `<span class="sqrt-symbol math-template">
                <span>√</span>
                <span class="sqrt-content">
                    <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                </span>
            </span>`,

            sqrt_power: `<span class="sqrt-symbol math-template">
                <span>√</span>
                <span class="sqrt-content">
                    <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                    <sup class="editable-field" contenteditable="true" data-placeholder=""></span>
                </span>
            </span>`,

<!--            nroot: `<span class="sqrt-symbol math-template">-->
<!--                <sup class="editable-field" contenteditable="true" data-placeholder="n"></span>-->
<!--                <span>√</span>-->
<!--                <span class="sqrt-content">-->
<!--                    <span class="editable-field" contenteditable="true" data-placeholder=""></span>-->
<!--                </span>-->
<!--            </span>`,-->

            nroot: `<span class="sqrt-symbol math-template">
                <sup class="editable-field" contenteditable="true" data-placeholder="n"></sup>
                <span>√</span>
                <span class="sqrt-content">
                    <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                </span>
            </span>`,

            power: `<span class="power-template math-template">
                <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                <sup class="editable-field" contenteditable="true" data-placeholder=""></span>
            </span>`,

            square: `<span class="square-template math-template">
                <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                <sup>2</sup>
            </span>`,

            cube: `<span class="cube-template math-template">
                <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                <sup>3</sup>
            </span>`,

            small_power: `<sup class="editable-field small-power math-template" contenteditable="true" data-placeholder=""></span>`,

            frac: `<span class="fraction math-template">
                <span class="numerator editable-field" contenteditable="true" data-placeholder=""></span>
                <span class="denominator editable-field" contenteditable="true" data-placeholder=""></span>
            </span>`,

            subscript: `<sub class="editable-field math-template" contenteditable="true" data-placeholder=""></span>`,

            big_parentheses_right: `<span class="big-brackets parentheses math-template">
                <span class="bracket-left">(</span>
                <span class="editable-field" contenteditable="true" data-placeholder=""></span>
            </span>`,

            big_parentheses_left: `<span class="big-brackets parentheses math-template">
                <span class="editable-field" contenteditable="true" data-placeholder=""></span>
                <span class="bracket-right">)</span>
            </span>`,

            sin: `<span class="function-template math-template">sin(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,
            cos: `<span class="function-template math-template">cos(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,
            tan: `<span class="function-template math-template">tg(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,
            cot: `<span class="function-template math-template">ctg(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,
            log: `<span class="function-template math-template">log(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,
            limit: `<span class="function-template math-template">lim(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,

            just: `<span class="parentheses-template math-template">(<span class="editable-field" contenteditable="true" data-placeholder=""></span>)</span>`,
            abs: `<span class="abs-template math-template">|<span class="editable-field" contenteditable="true" data-placeholder=""></span>|</span>`,

            vertical_stack: `<span class="vertical-stack-container math-template">
                <span class="stack-top editable-field" contenteditable="true" data-placeholder=""></span>
                <span class="stack-bottom editable-field" contenteditable="true" data-placeholder=""></span>
            </span>`,

            def_integral: `<span class="integral-template math-template" style="display: inline-flex; align-items: center; vertical-align: middle;">
                <span class="integral-limits" style="display: inline-flex; flex-direction: column; align-items: center; margin-right: 3px;">
                    <sup class="editable-field" contenteditable="true" data-placeholder="" style="font-size: 0.7em; line-height: 1; border: 1px dashed #ccc; padding: 0 2px; min-width: 10px;"></sup>
                    <span style="font-size: 1.2em; line-height: 1;">∫</span>
                    <sub class="editable-field" contenteditable="true" data-placeholder="" style="font-size: 0.7em; line-height: 1; border: 1px dashed #ccc; padding: 0 2px; min-width: 10px;"></sub>
                </span>
                <span class="editable-field" contenteditable="true" data-placeholder="" style="border: 1px dashed #ccc; padding: 0 4px; min-width: 20px; margin: 0 2px;"></span>
                <span>d</span>
                <span class="editable-field" contenteditable="true" data-placeholder="" style="border: 1px dashed #ccc; padding: 0 4px; min-width: 10px; margin-left: 2px;"></span>
            </span>`,

            integral_symbol: "∫",

            integral_limits: `<span class="integral-template math-template" style="display: inline-flex; align-items: center; vertical-align: middle;">
                <span style="display: inline-flex; flex-direction: column; align-items: center; margin-right: 3px;">
                    <sup class="editable-field" contenteditable="true" data-placeholder="" style="font-size: 0.7em; line-height: 1; border: 1px dashed #ccc; padding: 0 2px; min-width: 10px;"></sup>
                    <span style="font-size: 1.2em; line-height: 1;">∫</span>
                    <sub class="editable-field" contenteditable="true" data-placeholder="" style="font-size: 0.7em; line-height: 1; border: 1px dashed #ccc; padding: 0 2px; min-width: 10px;"></sub>
                </span>
                <span class="editable-field" contenteditable="true" data-placeholder="" style="border: 1px dashed #ccc; padding: 0 4px; min-width: 20px; margin: 0 2px;"></span>
            </span>`,
        };

        this.init();
    }

    init() {
        this.setupEventListeners();
        this.initializeDisplay();
        this.setupPlaceholderBehavior();
        this.showPanel('basic');
    }

    setupEventListeners() {
        // Вкладки
        document.querySelectorAll('.keyboard-tab').forEach(tab => {
            tab.addEventListener('mousedown', (e) => {
                e.preventDefault();
                this.showPanel(e.target.dataset.tab);
            });
        });

        // Кнопки клавиатуры
        const keyboardContainer = document.querySelector('.keyboard-container');
        if (keyboardContainer) {
            keyboardContainer.addEventListener('mousedown', (e) => {
                const key = e.target.closest('.key');
                if (key) {
                    e.preventDefault();

                    if (key.dataset.symbol) {
                        this.insertSymbol(key.dataset.symbol);
                    } else if (key.dataset.template) {
                        this.insertTemplate(key.dataset.template);
                    } else if (key.dataset.action === 'backspace') {
                        this.handleBackspace();
                    }

                    // Сохраняем фокус
                    this.restoreFocus();
                }
            });
        }

        // Управляющие кнопки
        document.getElementById('clearBtn').addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.clear();
        });

        document.getElementById('saveBtn').addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.save();
        });

        this.setupDisplayEvents();
    }

    initializeDisplay() {
        const display = document.getElementById('formulaDisplay');
        display.innerHTML = '';
        display.setAttribute('contenteditable', 'true');
        display.classList.add('math-formula-editable');

        // Добавляем нулевой пробел для возможности установки курсора
        const zeroSpace = document.createTextNode('\u200B');
        display.appendChild(zeroSpace);

        // Устанавливаем фокус на дисплей
        setTimeout(() => {
            display.focus();
            this.setCursorToPosition(display, 0);
        }, 100);
    }

    setupDisplayEvents() {
        const display = document.getElementById('formulaDisplay');

        display.addEventListener('focus', () => {
            this.lastActiveElement = display;
        });

        display.addEventListener('click', (e) => {
            // При клике на дисплей устанавливаем курсор в место клика
            if (e.target === display || e.target.classList.contains('math-formula-editable')) {
                this.lastActiveElement = display;
            }
        });

        display.addEventListener('input', (e) => {
            this.updateCurrentFormula();
        });

        display.addEventListener('keydown', (e) => {
            this.handleKeydown(e);
        });

        display.addEventListener('compositionstart', () => {
            this.isComposing = true;
        });

        display.addEventListener('compositionend', () => {
            this.isComposing = false;
        });

        // Обработка кликов по редактируемым полям внутри шаблонов
        display.addEventListener('mousedown', (e) => {
            const editableField = e.target.closest('.editable-field, .numerator, .denominator, .stack-top, .stack-bottom');
            if (editableField) {
                e.preventDefault();
                e.stopPropagation();
                this.lastActiveElement = editableField;
                setTimeout(() => {
                    editableField.focus();
                    this.setCursorToEnd(editableField);
                }, 10);
            }
        });

        // Обработка кликов на шаблоны (но не на поля)
        display.addEventListener('mousedown', (e) => {
            const template = e.target.closest('.math-template');
            if (template && !e.target.closest('.editable-field')) {
                e.preventDefault();
                e.stopPropagation();
                // При клике на шаблон устанавливаем курсор после него
                setTimeout(() => {
                    this.setCursorAfterElement(template);
                }, 10);
            }
        });
    }

    // Упрощенная установка курсора после элемента
    setCursorAfterElement(element) {
        const range = document.createRange();
        const selection = window.getSelection();

        range.setStartAfter(element);
        range.setEndAfter(element);
        range.collapse(true);

        selection.removeAllRanges();
        selection.addRange(range);

        this.lastActiveElement = document.getElementById('formulaDisplay');
    }

    // Установка курсора в определенную позицию
    setCursorToPosition(element, position) {
        const range = document.createRange();
        const selection = window.getSelection();

        if (element.childNodes.length > 0) {
            const textNode = this.findTextNode(element);
            if (textNode) {
                const len = textNode.textContent.length;
                range.setStart(textNode, Math.min(position, len));
                range.setEnd(textNode, Math.min(position, len));
            } else {
                range.selectNodeContents(element);
                range.collapse(false);
            }
        } else {
            range.selectNodeContents(element);
            range.collapse(false);
        }

        selection.removeAllRanges();
        selection.addRange(range);
    }

    // Поиск текстового узла
    findTextNode(element) {
        for (let node of element.childNodes) {
            if (node.nodeType === Node.TEXT_NODE) {
                return node;
            }
            if (node.nodeType === Node.ELEMENT_NODE) {
                const found = this.findTextNode(node);
                if (found) return found;
            }
        }
        return null;
    }

    // Упрощенная вставка символа
    insertSymbol(symbol) {
        if (this.isComposing) return;

        const display = document.getElementById('formulaDisplay');
        const selection = window.getSelection();

        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);

            // Удаляем нулевой пробел если он есть в выделении
            if (range.startContainer.nodeType === Node.TEXT_NODE &&
                range.startContainer.textContent === '\u200B') {
                range.deleteContents();
            }

            const textNode = document.createTextNode(symbol);
            range.insertNode(textNode);

            // Перемещаем курсор после вставленного символа
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
            // Если нет выделения, добавляем в конец
            const textNode = document.createTextNode(symbol);
            display.appendChild(textNode);
            this.setCursorToEnd(display);
        }

        this.updateCurrentFormula();
    }

    // Добавь этот метод в класс MathKeyboard
    setCursorAfter(element) {
        const range = document.createRange();
        const sel = window.getSelection();

        range.setStartAfter(element);
        range.collapse(true);

        sel.removeAllRanges();
        sel.addRange(range);
    }
     // Добавьте этот метод для управления плейсхолдерами
    setupPlaceholderBehavior() {
        const display = document.getElementById('formulaDisplay');

        // Обработчик для фокуса - скрываем плейсхолдер
        display.addEventListener('focusin', (e) => {
            const field = e.target.closest('.editable-field');
            if (field && field.hasAttribute('data-placeholder')) {
                field.classList.remove('show-placeholder');
            }
        });

        // Обработчик для потери фокуса - показываем плейсхолдер если пусто
        display.addEventListener('focusout', (e) => {
            const field = e.target.closest('.editable-field');
            if (field && field.hasAttribute('data-placeholder')) {
                if (!field.textContent.trim()) {
                    field.classList.add('show-placeholder');
                }
            }
        });

        // Обработчик ввода - убираем плейсхолдер при вводе
        display.addEventListener('input', (e) => {
            const field = e.target.closest('.editable-field');
            if (field && field.hasAttribute('data-placeholder')) {
                field.classList.remove('show-placeholder');
            }
        });
    }

// Обновите метод insertTemplate
    insertTemplate(templateName) {
        if (!this.templates[templateName]) return;

        const display = document.getElementById('formulaDisplay');
        const selection = window.getSelection();
        const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = this.templates[templateName];
        const templateElement = tempDiv.firstChild;

        // Настраиваем плейсхолдеры для редактируемых полей
        const editableFields = templateElement.querySelectorAll('.editable-field');
        editableFields.forEach(field => {
            const placeholder = field.getAttribute('data-placeholder');

            // Добавляем CSS класс для плейсхолдера
            field.classList.add('math-placeholder-field');

            // Устанавливаем плейсхолдер как псевдо-элемент через CSS
            field.style.setProperty('--placeholder-text', `"${placeholder}"`);

            // Показываем плейсхолдер изначально
            field.classList.add('show-placeholder');
        });

        if (range) {
            if (range.startContainer.nodeType === Node.TEXT_NODE &&
                range.startContainer.textContent === '\u200B') {
                range.deleteContents();
            }

            range.insertNode(templateElement);

            const zeroSpace = document.createTextNode('\u200B');
            range.insertNode(zeroSpace);

            range.setStartAfter(zeroSpace);
            range.setEndAfter(zeroSpace);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
            display.appendChild(templateElement);
            const zeroSpace = document.createTextNode('\u200B');
            display.appendChild(zeroSpace);
            this.setCursorToEnd(display);
        }

        this.updateCurrentFormula();
    }

// Упрощенная установка курсора после элемента
setCursorAfter(element) {
    const range = document.createRange();
    const selection = window.getSelection();

    range.setStartAfter(element);
    range.setEndAfter(element);
    range.collapse(true);

    selection.removeAllRanges();
    selection.addRange(range);

    this.lastActiveElement = document.getElementById('formulaDisplay');
}


    restoreFocus() {
        setTimeout(() => {
            const display = document.getElementById('formulaDisplay');
            if (display && document.body.contains(display)) {
                display.focus();
                // Устанавливаем курсор в конец
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(display);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }, 50);
    }

    setCursorToEnd(element) {
        const range = document.createRange();
        const selection = window.getSelection();

        range.selectNodeContents(element);
        range.collapse(false);

        selection.removeAllRanges();
        selection.addRange(range);
    }

    handleKeydown(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            this.navigateEditableFields(e.shiftKey);
        } else if (e.key === 'Escape') {
            // Выход из редактируемого поля в основной дисплей
            const display = document.getElementById('formulaDisplay');
            this.lastActiveElement = display;
            display.focus();
            this.setCursorToEnd(display);
        }
    }

    navigateEditableFields(backward = false) {
        const display = document.getElementById('formulaDisplay');
        const allEditables = Array.from(display.querySelectorAll('.editable-field, .numerator, .denominator, .stack-top, .stack-bottom'));

        if (allEditables.length === 0) return;

        const currentElement = this.lastActiveElement;
        let currentIndex = allEditables.indexOf(currentElement);

        if (currentIndex === -1) {
            currentIndex = backward ? allEditables.length - 1 : 0;
        } else {
            if (backward) {
                currentIndex = currentIndex > 0 ? currentIndex - 1 : allEditables.length - 1;
            } else {
                currentIndex = currentIndex < allEditables.length - 1 ? currentIndex + 1 : 0;
            }
        }

        if (allEditables[currentIndex]) {
            this.lastActiveElement = allEditables[currentIndex];
            allEditables[currentIndex].focus();
            this.setCursorToEnd(allEditables[currentIndex]);
        }
    }

    handleBackspace() {
        const display = document.getElementById('formulaDisplay');
        const selection = window.getSelection();

        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);

            if (!range.collapsed) {
                range.deleteContents();
            } else {
                // Удаляем символ перед курсором
                const startContainer = range.startContainer;
                const startOffset = range.startOffset;

                if (startOffset > 0) {
                    if (startContainer.nodeType === Node.TEXT_NODE) {
                        // Удаляем один символ из текстового узла
                        const newText = startContainer.textContent.substring(0, startOffset - 1) +
                                       startContainer.textContent.substring(startOffset);
                        startContainer.textContent = newText;
                        range.setStart(startContainer, startOffset - 1);
                    }
                } else if (startContainer !== display) {
                    // Если в начале элемента, пытаемся удалить предыдущий элемент
                    const previousNode = startContainer.previousSibling || startContainer.parentNode.previousSibling;
                    if (previousNode) {
                        previousNode.remove();
                    }
                }
            }

            this.updateCurrentFormula();
        }
    }

    updateCurrentFormula() {
        const display = document.getElementById('formulaDisplay');
        this.currentFormula = display.innerHTML;
    }

    clear() {
        this.showClearConfirmationModal();
    }

    showClearConfirmationModal() {
        const modal = document.createElement('div');
        modal.className = 'custom-confirm-modal';
        modal.innerHTML = `
            <div class="custom-confirm-backdrop"></div>
            <div class="custom-confirm-container">
                <div class="custom-confirm-header">
                    <h3><i class="fi fi-sr-eraser"></i> Очистить формулу</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="custom-confirm-body">
                    <p>Вы уверены, что хотите очистить всю формулу? Это действие нельзя отменить.</p>
                    <div class="custom-confirm-buttons">
                        <button class="custom-confirm-btn cancel-btn">Отмена</button>
                        <button class="custom-confirm-btn confirm-btn btn-danger">Очистить</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        const closeModal = () => document.body.removeChild(modal);

        modal.querySelector('.close-btn').addEventListener('click', closeModal);
        modal.querySelector('.cancel-btn').addEventListener('click', closeModal);
        modal.querySelector('.confirm-btn').addEventListener('click', () => {
            this.clearWithoutConfirm();
            closeModal();
        });
        modal.querySelector('.custom-confirm-backdrop').addEventListener('click', closeModal);
    }

    clearWithoutConfirm() {
        const display = document.getElementById('formulaDisplay');
        display.innerHTML = '';

        // Добавляем нулевой пробел обратно
        const zeroSpace = document.createTextNode('\u200B');
        display.appendChild(zeroSpace);

        this.currentFormula = '';
        this.lastActiveElement = display;

        setTimeout(() => {
            display.focus();
            this.setCursorToPosition(display, 0);
        }, 100);

        this.showNotification('Формула очищена', 'info');
    }

    save() {
        const data = {
            formula: this.currentFormula,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('mathKeyboard', JSON.stringify(data));
        this.showNotification('Формула сохранена!', 'info');
    }

    showPanel(panelName) {
        document.querySelectorAll('.keyboard-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === panelName);
        });

        document.querySelectorAll('.keyboard-panel').forEach(panel => {
            panel.classList.toggle('active', panel.id === panelName + 'Panel');
        });
    }

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `math-keyboard-notification ${type}`;
        notification.textContent = message;

        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${type === 'info' ? '#2196F3' : '#f44336'};
            color: white;
            border-radius: 4px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // Получение финальной формулы для отображения
    getFinalFormula() {
        const display = document.getElementById('formulaDisplay');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = display.innerHTML;

        // Удаляем нулевые пробелы
        const walker = document.createTreeWalker(
            tempDiv,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        let node;
        const nodesToRemove = [];
        while (node = walker.nextNode()) {
            if (node.textContent === '\u200B') {
                nodesToRemove.push(node);
            } else {
                node.textContent = node.textContent.replace(/\u200B/g, '');
            }
        }

        nodesToRemove.forEach(node => {
            if (node.parentNode) {
                node.parentNode.removeChild(node);
            }
        });

        // Удаляем атрибуты редактирования
        const editableElements = tempDiv.querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
            el.removeAttribute('contenteditable');
            el.classList.remove('editable-field');
            el.removeAttribute('data-placeholder');

            // Заменяем плейсхолдеры
            if (el.textContent === '□' || el.textContent.trim() === '□') {
                el.textContent = '';
            }
        });

        return tempDiv.innerHTML;
    }

    // Обновите метод getStaticFormula для обработки плейсхолдеров
    getStaticFormula() {
        const display = document.getElementById('formulaDisplay');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = display.innerHTML;

        // Удаляем нулевые пробелы
        const walker = document.createTreeWalker(
            tempDiv,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );

        let node;
        while (node = walker.nextNode()) {
            if (node.textContent === '\u200B') {
                node.parentNode.removeChild(node);
            } else {
                node.textContent = node.textContent.replace(/\u200B/g, '');
            }
        }

        // Обрабатываем редактируемые поля
        const editableElements = tempDiv.querySelectorAll('.editable-field');
        editableElements.forEach(el => {
            el.removeAttribute('contenteditable');
            el.classList.remove('editable-field', 'math-placeholder-field', 'show-placeholder');
            el.removeAttribute('data-placeholder');
            el.style.removeProperty('--placeholder-text');

            // Удаляем пустые поля
            if (!el.textContent.trim()) {
                el.remove();
            }
        });

        // Удаляем классы шаблонов
        const mathTemplates = tempDiv.querySelectorAll('.math-template');
        mathTemplates.forEach(template => {
            template.classList.remove('math-template');
        });

        return tempDiv.innerHTML;
    }

}
        // Добавьте эту функцию если хотите возможность удалять фото
function removeImage(previewId) {
    const preview = document.getElementById(previewId);
    const input = preview.parentElement.querySelector('.image-upload-input');

    preview.style.display = 'none';
    preview.innerHTML = '';
    input.value = '';
}

     document.getElementById('mathTestForm').addEventListener('submit', function(e) {

    console.log("=== ОТЛАДКА ПЕРЕД ОТПРАВКОЙ ФОРМЫ ===");

    const answerFormulas = document.querySelectorAll('input[name="answer_formula[]"]');
    const answerImages = document.querySelectorAll('input[name="answer_images[]"]');
    const correctAnswer = document.querySelector('input[name="correct_answer"]:checked');

    console.log("Количество формул ответов:", answerFormulas.length);
    console.log("Количество полей для фото:", answerImages.length);
    console.log("Правильный ответ:", correctAnswer ? correctAnswer.value : 'не выбран');

    // Проверим ВСЕ данные формы
    const formData = new FormData(this);
    console.log("=== ВСЕ ДАННЫЕ ФОРМЫ ===");
    for (let [key, value] of formData.entries()) {
        if (key === 'answer_images[]') {
            console.log(`${key}:`, value.name, value.size, "bytes");
        } else {
            console.log(`${key}:`, value);
        }
    }

    // Теперь можно отправить форму вручную для тестирования
    // this.submit();
});

        function handleQuestionImageUpload(input, questionIndex) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        const preview = document.getElementById(`questionImagePreview_${questionIndex}`);
        const uploadContainer = document.getElementById(`imageUpload_${questionIndex}`);
        const fileName = document.getElementById(`fileName_${questionIndex}`);
        const fileSize = document.getElementById(`fileSize_${questionIndex}`);

        reader.onload = function(e) {
            preview.src = e.target.result;
            uploadContainer.classList.add('has-image');

            // Показываем информацию о файле
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
        }
        reader.readAsDataURL(file);
    }
}

function removeQuestionImage(questionIndex) {
    const input = document.querySelector(`input[name="question_image_${questionIndex}"]`);
    const preview = document.getElementById(`questionImagePreview_${questionIndex}`);
    const uploadContainer = document.getElementById(`imageUpload_${questionIndex}`);
    const fileName = document.getElementById(`fileName_${questionIndex}`);
    const fileSize = document.getElementById(`fileSize_${questionIndex}`);

    input.value = '';
    preview.src = '';
    uploadContainer.classList.remove('has-image');
    fileName.textContent = '';
    fileSize.textContent = '';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
</body>
</html>